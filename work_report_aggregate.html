<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <title>業務終了報告集約</title>
  <style>
    :root {
      --fg: #111;
      --muted: #666;
      --accent: #2962ff;
      --danger: #d32f2f;
      --ok: #2e7d32;
      --bg: #fafafa;
      --card: #ffffff;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; }
    body {
      margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial,
      "Apple Color Emoji", "Segoe UI Emoji"; color: var(--fg); background: var(--bg);
      line-height: 1.6; font-size: 16px;
      touch-action: manipulation;
    }
    header.toolbar {
      position: sticky; top: 0; z-index: 10; display: flex; align-items: center; gap: .75rem;
      padding: .75rem; background: var(--card); border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .spacer { flex: 1; }
    .version { color: var(--muted); font-size: .95rem; }
    .container { max-width: 980px; margin: 0 auto; padding: .25rem .75rem 2rem; }

    .row { display: flex; flex-wrap: wrap; gap: .5rem .75rem; align-items: center; }
    label.inline { display: inline-flex; align-items: center; gap: .5rem; }
    input[type="text"]{
      font-size: 16px; /* iOS ズーム抑止 */
      padding: .5rem .6rem; border: 1px solid var(--border); border-radius: .5rem; background: #fff;
      min-width: 8ch;
    }
    button {
      appearance: none; border: 1px solid var(--border); background: #fff; color: var(--fg);
      padding: .55rem .9rem; border-radius: .65rem; cursor: pointer; font-size: 16px; transition: .15s;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.06); }
    button:active { transform: translateY(0); box-shadow: none; }
    button.primary { background: var(--accent); color: #fff; border-color: transparent; }
    button:disabled { opacity: .6; pointer-events: none; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: .75rem; padding: 1rem; margin-top: .75rem; }
    .note { color: var(--muted); font-size: .9rem; }
    .msg { margin-top: .5rem; font-size: .95rem; }
    .msg.error { color: var(--danger); }
    .msg.ok { color: var(--ok); }

    .spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid var(--border); border-top-color: var(--accent);
      border-radius: 50%; animation: spin 1s linear infinite; vertical-align: -0.2em; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 640px) {
      .row { gap: .5rem; }
    }
  </style>
</head>
<body>
  <header class="toolbar">
    <button id="backBtn">トップに戻る</button>
    <div class="spacer"></div>
    <!-- バージョン情報は HTML 内にのみ定義 -->
    <div class="version" id="versionText">Ver.20250906-AGG-A</div>
  </header>

  <div class="container">
    <section class="card" aria-label="集約操作">
      <div class="row">
        <label class="inline" for="ymInput"><span>対象年月</span>
          <input id="ymInput" type="text" inputmode="numeric" pattern="\d{6}" placeholder="yyyymm" aria-describedby="ymHelp">
        </label>
        <button id="aggBtn" class="primary">終了報告集約</button>
      </div>
      <div id="ymHelp" class="note">例：202509（6桁）。初期値は操作日の年月です。</div>
      <div id="status" class="note" style="margin-top:.5rem"></div>
      <div id="msg" class="msg" role="status" aria-live="polite"></div>
    </section>
  </div>

<script>
(function(){
  // ===== Consts =====
  const GAS_DEPLOY_ID = 'AKfycbxrnvzng88PDqgnubPyHC1n82EXZn8_zHU9EoAL922BcKwDc4QamCtQlpiaSwdWwS3mNg';
  const GAS_BASE_URL = `https://script.google.com/macros/s/${GAS_DEPLOY_ID}/exec`;
  const FOLDERS = { workCompletion: 'work_completion_report' };

  // ===== Elements =====
  const els = {
    backBtn: document.getElementById('backBtn'),
    ymInput: document.getElementById('ymInput'),
    aggBtn: document.getElementById('aggBtn'),
    status: document.getElementById('status'),
    msg: document.getElementById('msg')
  };

  // ===== Utils =====
  function yyyymmJST(date=new Date()){
    const tz = 9*60; // minutes
    const t = date.getTime() + (date.getTimezoneOffset() + tz) * 60000;
    const d = new Date(t);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    return `${y}${m}`;
  }
  function setBusy(on){
    els.status.innerHTML = on ? `<span class="spinner" aria-label="読み込み中"></span> 処理中…` : '';
  }
  function showMsg(text, cls=''){
    els.msg.className = 'msg ' + (cls||'');
    els.msg.textContent = text || '';
  }
  function confirmBox(message){ return window.confirm(message); }

  // ===== CSV helpers =====
  function parseCsv(text){
    const rows = [];
    let i = 0, field = '', row = [], inQuote = false;
    const pushField = () => { row.push(field); field=''; };
    const pushRow = () => { rows.push(row); row=[]; };
    const s = String(text||'').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    while(i < s.length){
      const ch = s[i++];
      if(inQuote){
        if(ch === '"'){
          if(s[i] === '"'){ field += '"'; i++; }
          else { inQuote = false; }
        } else { field += ch; }
      } else {
        if(ch === '"'){ inQuote = true; }
        else if(ch === ','){ pushField(); }
        else if(ch === '\n'){ pushField(); pushRow(); }
        else { field += ch; }
      }
    }
    if(field.length>0 || row.length>0){ pushField(); pushRow(); }
    return rows;
  }
  function buildCsvFromRows(rows){
    const CRLF = '\r\n';
    const esc = (s)=>{ s=(s??'').toString(); return '"'+ s.replace(/"/g,'""') +'"'; };
    return rows.map(r => r.map((v,i) => i===0 && /[,\n\"]/.test(String(v)) ? esc(v) : esc(v)).join(',')).join(CRLF) + CRLF;
  }

  // ===== GAS helpers =====
  async function gasGet(params){
    const url = new URL(GAS_BASE_URL);
    Object.entries(params||{}).forEach(([k,v]) => url.searchParams.set(k, v));
    const res = await fetch(url.toString(), { method: 'GET', cache: 'no-cache' });
    if(!res.ok) throw new Error(`GAS GET ${res.status}`);
    const ct = res.headers.get('content-type') || '';
    if(ct.includes('application/json')) return res.json();
    return res.text();
  }
  async function gasPost(params, body){
    const url = new URL(GAS_BASE_URL);
    Object.entries(params||{}).forEach(([k,v]) => url.searchParams.set(k, v));
    const res = await fetch(url.toString(), { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body });
    if(!res.ok) throw new Error(`GAS POST ${res.status}`);
    const ct = res.headers.get('content-type') || '';
    if(ct.includes('application/json')) return res.json();
    return res.text();
  }
  async function listFiles(folder){ return gasGet({ action: 'list', folder }); }
  async function readFile(folder, file){ return gasGet({ action: 'read', folder, file }); }
  async function overwriteFile(folder, filename, content){
    // Excel対策：BOM + CRLF
    const CRLF = '\r\n';
    const txt = content.replace(/\r?\n/g, CRLF);
    const withBom = '\uFEFF' + txt;
    return gasPost({ action: 'overwrite', folder, filename }, withBom);
  }

  // ===== Domain logic =====
  function isYyyymm(v){ return /^\d{6}$/.test(v); }
  function filterTargetFiles(allNames, yyyymm){
    const re = new RegExp('^'+ yyyymm + '\\d{2}_.+?_業務終了報告\\.csv$');
    return (allNames||[]).filter(n => re.test(String(n)));
  }

  function extractRowFromReportCsv(csv){
    // 入力CSV 例：
    // 1行目: yyyymmdd,メンバ名,"業務終了報告"
    // 2行目: "対象コース", 値
    // 3行目: "実施業務", 値
    // 4行目: "チョコ券枚数", 値
    // 5行目: "報告事項", 値
    // 6行目: "お客様から褒められたこと", 値
    const rows = parseCsv(csv);
    const safe = (r,c)=> (rows[r] && rows[r][c] != null) ? String(rows[r][c]) : '';
    const ymd   = safe(0,0);
    const name  = safe(0,1);
    const course= safe(1,1);
    const work  = safe(2,1);
    const ticket= safe(3,1);
    const report= safe(4,1);
    const praise= safe(5,1);
    return [ymd, name, course, work, ticket, report, praise];
  }

  async function doAggregate(){
    const ym = (els.ymInput.value||'').trim();
    if(!isYyyymm(ym)){
      showMsg('対象年月は yyyymm の6桁で入力してください。', 'error');
      return;
    }

    setBusy(true); showMsg('集約対象を検索しています…');
    try{
      // 1) 一覧取得
      const list = await listFiles(FOLDERS.workCompletion);
      const names = Array.isArray(list) ? list : (Array.isArray(list?.files) ? list.files : []);
      const targets = filterTargetFiles(names, ym).sort(); // ファイル一覧の順（名前昇順）

      if(targets.length === 0){
        confirmBox('処理対象のファイルがありません。');
        showMsg('対象が見つかりませんでした。', 'error');
        return;
      }

      // 2) スタック配列準備（列は7固定、行は可変）
      const stack = [];
      // 先頭行：ヘッダ
      stack.push(['日付','メンバ名','対象コース','実施業務','チョコ券枚数','報告事項','お客様に褒められたこと']);

      // 3) 各ファイルを順に読み取り
      let processed = 0;
      for(const fn of targets){
        els.status.innerHTML = `<span class="spinner" aria-label="読み込み中"></span> 読込中… (${processed+1}/${targets.length})`;
        try{
          const csv = await readFile(FOLDERS.workCompletion, fn);
          if(typeof csv === 'string' && csv.trim()){
            const row = extractRowFromReportCsv(csv);
            // 列方向7つをそのまま push
            stack.push(row);
          }
        }catch(e){ /* 個別失敗はスキップ */ }
        processed++;
      }

      // 4) 出力CSVを構築
      const outCsv = buildCsvFromRows(stack);
      const outName = `${ym}_業務終了報告集約.csv`;

      // 5) 常時上書き保存
      els.status.innerHTML = `<span class="spinner" aria-label="保存中"></span> 保存中…`;
      await overwriteFile(FOLDERS.workCompletion, outName, outCsv);

      showMsg(`『${outName}』を作成しました。`, 'ok');
    }catch(err){
      console.error(err);
      showMsg('処理中にエラーが発生しました。時間をおいて再度お試しください。', 'error');
    }finally{
      setBusy(false);
    }
  }

  // ===== init & events =====
  els.backBtn.addEventListener('click', () => { window.location.href = 'top_menu.html'; });
  els.ymInput.value = yyyymmJST(); // 初期値：操作日の yyyymm
  els.aggBtn.addEventListener('click', doAggregate);
})();
</script>
</body>
</html>

