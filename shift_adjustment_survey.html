<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>シフト調整ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    html, body { margin:0; padding:0; font-family:sans-serif; width:100vw; height:100vh; overflow:auto; overscroll-behavior:none; }
    .header-bar { display:flex; align-items:center; gap:1em; padding:5px 10px; background:#f0f0f0; border-bottom:1px solid #ccc; font-size:14px; }
    button { padding:2px 6px; font-size:14px; cursor:pointer; }
    .status { font-weight:bold; color:red; display:inline-flex; align-items:center; gap:6px; }
    .spinner { border:3px solid #f3f3f3; border-top:3px solid red; border-radius:50%; width:14px; height:14px; animation:spin 1s linear infinite; display:none; }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    .grid { display:grid; grid-template-columns:110px repeat(31,36px); grid-auto-rows:30px; min-width:max-content; -webkit-overflow-scrolling:touch; }
    .cell { border:1px solid #ccc; text-align:center; line-height:30px; white-space:nowrap; user-select:none; background:#fff; font-size:14px; overflow:hidden; }
    .header-1 { position:sticky; top:0; background:#eee; z-index:5; }
    .header-2 { position:sticky; top:30px; background:#eee; z-index:5; }
    .fixed-col { position:sticky; left:0; background:#f8f8f8; padding-left:2.5em; z-index:4; }
    .header-1.fixed-col, .header-2.fixed-col { background:#eee; z-index:6; }
    .highlight-red { background:red !important; color:#fff; }
    .red { color:red; }
    #messageBox { position:fixed; top:10px; right:10px; background:#333; color:#fff; padding:10px 20px; border-radius:5px; opacity:0; transition:opacity .3s; z-index:9999; pointer-events:none; }
    #messageBox.show { opacity:1; }
    #messageBox.success { background:#28a745; } #messageBox.error { background:#dc3545; } #messageBox.info { background:#007bff; }
  </style>
</head>
<body>
  <button onclick="location.href='top_menu.html'">トップに戻る</button>

  <div class="header-bar">
    <span>回答者：</span><span id="memberName"></span>
    <span id="targetDate"></span>
    <span id="loadingStatus" class="status"><span id="loadingText"></span><span class="spinner" id="loadingSpinner"></span></span>
    <button id="exportBtn" style="display:none;">希望提出</button>
  </div>

  <div class="grid" id="grid"></div>
  <div id="version-label" style="text-align:left; margin:10px;">Ver.20250822-COURSEHEAD</div>
  <div id="messageBox"></div>

<script>
  // iOSバウンス防止
  document.addEventListener('touchmove', e => { if (!e.target.closest('.grid')) e.preventDefault(); }, { passive:false });

  const grid = document.getElementById("grid");
  const memberNameSpan = document.getElementById("memberName");
  const targetDateSpan = document.getElementById("targetDate");
  const exportBtn = document.getElementById("exportBtn");
  const messageBox = document.getElementById("messageBox");
  const loadingText = document.getElementById("loadingText");
  const loadingSpinner = document.getElementById("loadingSpinner");

  // GASエンドポイント & フォルダキーワード
  const gasUrl = "https://script.google.com/macros/s/AKfycby-OWiC-DnfTcHVvEXqdVq0F3-NI4yQHqb8-Vw7iZH1gtPS7MbmP1x1YIhXbiNdPrEUCg/exec";
  const folderKeyword = "shift_adjustment_survey";

  // 出力ファイル名末尾（固定）
  const FILE_SUFFIX = "シフト希望";

  let allInputLines = [];
  let cellRefs = [];
  let year = '';
  let month = '';
  let targetYm = '';
  let highlightData = [];

  const userName = localStorage.getItem("userName") || "未設定";
  memberNameSpan.textContent = userName;

  document.addEventListener("DOMContentLoaded", () => { showLoading("処理中..."); });

  function showLoading(msg){ loadingText.textContent = msg; loadingSpinner.style.display = "inline-block"; }
  function hideLoading(){ loadingText.textContent = ""; loadingSpinner.style.display = "none"; }
  function showMessage(msg, type='info'){ messageBox.className = `show ${type}`; messageBox.textContent = msg; setTimeout(()=>messageBox.classList.remove('show'),3000); }
  function parseCSVLine(line){ return line.split(',').map(s => s.trim()); }

  // 初期ロード：input_data.txt を読み、YYYY/MM → targetYm を決定
  function initAllData(){
    showLoading("処理中...");
    fetch(`${gasUrl}?action=read&folder=${folderKeyword}&file=input_data.txt`)
      .then(res => res.text())
      .then(text => {
        allInputLines = text.split('\n').filter(l => l.trim());
        const ym = parseCSVLine(allInputLines[0]); // 例: 年月,2025,08
        year  = ym[1];
        month = ym[2];
        targetYm = `${year}${String(month).padStart(2,'0')}`;
        targetDateSpan.textContent = `対象：${year}年${month}月`;
        loadDataForMember(userName);
      })
      .catch(err => { showMessage("ヘッダ情報の読み込みに失敗しました。\n"+err.message,'error'); hideLoading(); });
  }

  function loadGridFromData(lines){
    grid.innerHTML = ''; cellRefs = [];
    const data = lines.map(parseCSVLine);
    const rowCount = data.length;
    const colCount = 32;
    const fragment = document.createDocumentFragment();

    for (let r=0; r<rowCount; r++){
      const row = [];
      for (let c=0; c<colCount; c++){
        const cell = document.createElement("div");
        cell.className = "cell";
        const val = data[r]?.[c] ?? '';
        if (c===0) cell.classList.add("fixed-col");

        if (r===0){
          cell.classList.add("header-1");
          cell.textContent = c>0 ? val : "日付";
        } else if (r===1){
          cell.classList.add("header-2");
          cell.innerHTML = c>0 ? (['土','日'].includes(val) ? `<span class="red">${val}</span>` : val) : "曜日";
        } else {
          cell.textContent = val;
          if (c>0 && val!==""){ cell.onclick = () => handleCellClick(r, c, cell); }
        }
        fragment.appendChild(cell);
        row.push(cell);
      }
      cellRefs.push(row);
    }
    grid.appendChild(fragment);
    applyHighlight();
    hideLoading();
  }

  // クリック：赤⇔なし
  function handleCellClick(rowIndex, colIndex, cell){
    if (cell.classList.contains("highlight-red")){
      cell.classList.remove("highlight-red");
    } else {
      cell.classList.add("highlight-red");
    }
  }

  // 読み込み：値が "1" のセルだけ赤にする
  function applyHighlight(){
    if (!highlightData.length) return;
    // highlightData[0]: 回答者,xxx
    // highlightData[1]: 年月,YYYY,MM
    // highlightData[2] 以降：ヘッダ日付行, 曜日行, データ行...
    for (let r=0; r<cellRefs.length; r++){
      const line = highlightData[2 + r] || '';
      const row = line.split(',');
      for (let c=1; c<row.length && c<cellRefs[r].length; c++){
        if (r >= 2 && row[c] === '1'){ // データ行のみ
          cellRefs[r][c].classList.add("highlight-red");
        }
      }
    }
  }

  // input_data のヘッダ2行＋データ行をベースに表示（既存CSV側の先頭コース名は無視）
  function mergeInputAndOutput(inputLines, outputLines){
    highlightData = [...outputLines]; // ハイライトは出力準拠（"1"のみを参照）
    const merged = [];
    // input_data.txt 構成：
    // 0: 年月,YYYY,MM
    // 1: 日付行
    // 2: 曜日行
    // 3以降: データ行（先頭セル=コース名）
    merged[0] = inputLines[1];
    merged[1] = inputLines[2];
    for (let r=3; r<inputLines.length; r++){ merged.push(inputLines[r]); }
    return merged;
  }

  // 既存：完全一致 [メンバ名]_[YYYYMM]シフト希望.txt があれば編集、無ければ新規
  function loadDataForMember(member){
    showLoading("処理中...");
    const prefix = `${member}_`;
    const exactName = `${member}_${targetYm}${FILE_SUFFIX}.txt`;

    fetch(`${gasUrl}?action=list&folder=${folderKeyword}&prefix=${encodeURIComponent(prefix)}`)
      .then(res => res.json())
      .then(data => {
        const inputLines = allInputLines;
        const files = (data.result === "success" && Array.isArray(data.files)) ? data.files : [];
        const hasExact = files.includes(exactName);

        if (hasExact){
          fetch(`${gasUrl}?action=read&folder=${folderKeyword}&file=${encodeURIComponent(exactName)}`)
            .then(res => res.text())
            .then(outputText => {
              const outputLines = outputText.split('\n').filter(l => l.trim());
              const merged = mergeInputAndOutput(inputLines, outputLines);
              loadGridFromData(merged);
              exportBtn.style.display = 'inline-block';
            })
            .catch(err => { showMessage("ファイル読み込みに失敗しました。\n"+err.message,'error'); hideLoading(); });
        } else {
          const merged = [ inputLines[1], inputLines[2], ...inputLines.slice(3) ];
          loadGridFromData(merged);
          exportBtn.style.display = 'inline-block';
        }
      })
      .catch(err => { showMessage("ファイルチェックに失敗しました。\n"+err.message,'error'); hideLoading(); });
  }

  // 保存：ヘッダ2行は文字、データ行は赤=1／それ以外=空（先頭列はコース名）
  exportBtn.addEventListener('click', () => {
    showLoading("処理中...");
    let csv = `回答者,${userName}\n年月,${year},${month}\n`;
    const rowCount = cellRefs.length;
    const colCount = 32;

    for (let r=0; r<rowCount; r++){
      const row = [];
      for (let c=0; c<colCount; c++){
        if (r < 2){
          row.push(cellRefs[r][c]?.textContent ?? '');
        } else {
          if (c === 0) {
            // コース名を必ず出力（input_data.txt由来の見出しセル）
            row.push(cellRefs[r][0]?.textContent ?? '');
          } else {
            row.push(cellRefs[r][c]?.classList.contains("highlight-red") ? '1' : '');
          }
        }
      }
      csv += row.join(',') + '\n';
    }

    // ファイル名：[メンバ名]_[YYYYMM]シフト希望.txt
    const filename = `${userName}_${targetYm}${FILE_SUFFIX}.txt`;

    // 上書き/新規自動判定
    fetch(`${gasUrl}?action=overwrite&folder=${folderKeyword}&filename=${encodeURIComponent(filename)}`, {
      method:'POST', body:csv, headers:{ 'Content-Type':'text/plain' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.result === 'success'){
        const op    = data.operation || 'create';
        const made  = data.created === true ? '（新規作成）' : (data.created === false ? '（上書き）' : '');
        const hits  = (typeof data.matched === 'number') ? `\n同名ヒット数：${data.matched}` : '';
        showMessage(`保存しました！\nファイル名：${filename}\n処理：${op}${made}${hits}`, 'success');
      } else {
        showMessage("保存エラー：" + data.message, 'error');
      }
      hideLoading();
    })
    .catch(err => { showMessage("通信エラー：" + err.message, 'error'); hideLoading(); });
  });

  window.onload = initAllData;
</script>
<script src="reload.js?v=20250724"></script>
</body>
</html>
