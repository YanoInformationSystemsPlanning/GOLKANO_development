<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>シフト調整ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    html, body { margin:0; padding:0; font-family:sans-serif; width:100vw; height:100vh; overflow:auto; overscroll-behavior:none; }
    .header-bar { display:flex; align-items:center; gap:1em; padding:5px 10px; background:#f0f0f0; border-bottom:1px solid #ccc; font-size:14px; }
    button { padding:2px 6px; font-size:14px; cursor:pointer; }
    .status { font-weight:bold; color:red; display:inline-flex; align-items:center; gap:6px; }
    .spinner { border:3px solid #f3f3f3; border-top:3px solid red; border-radius:50%; width:14px; height:14px; animation:spin 1s linear infinite; display:none; }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

    /* ★ 右端に「コースごとの備考」列（30ch）を追加 */
    .grid { display:grid; grid-template-columns:110px repeat(31,36px) 32ch; grid-auto-rows:30px; min-width:max-content; -webkit-overflow-scrolling:touch; }

    .cell { border:1px solid #ccc; text-align:center; line-height:30px; white-space:nowrap; user-select:none; background:#fff; font-size:14px; overflow:hidden; }
    /* ★ スティッキーの段数を1段分繰り下げ（共通備考を最上段に） */
    .header-0 { position:sticky; top:0; background:#eee; z-index:7; }     /* 共通備考 */
    .header-1 { position:sticky; top:30px; background:#eee; z-index:6; }  /* 日付 */
    .header-2 { position:sticky; top:60px; background:#eee; z-index:5; }  /* 曜日 */
    .fixed-col { position:sticky; left:0; background:#f8f8f8; padding-left:2.5em; z-index:4; }
    .header-0.fixed-col, .header-1.fixed-col, .header-2.fixed-col { background:#eee; z-index:8; }

    .highlight-red { background:red !important; color:#fff; }
    .red { color:red; }

    #messageBox { position:fixed; top:10px; right:10px; background:#333; color:#fff; padding:10px 20px; border-radius:5px; opacity:0; transition:opacity .3s; z-index:9999; pointer-events:none; }
    #messageBox.show { opacity:1; }
    #messageBox.success { background:#28a745; } #messageBox.error { background:#dc3545; } #messageBox.info { background:#007bff; }

    /* ★ 入力欄の見た目を控えめに */
    .remark-input { width:100%; box-sizing:border-box; height:28px; border:1px solid #bbb; padding:0 6px; font-size:14px; }
    .remark-input::placeholder { color:#999; }
  </style>
</head>
<body>
  <button onclick="location.href='top_menu.html'">トップに戻る</button>

  <div class="header-bar">
    <span>回答者：</span><span id="memberName"></span>
    <span id="targetDate"></span>
    <span id="loadingStatus" class="status"><span id="loadingText"></span><span class="spinner" id="loadingSpinner"></span></span>
    <button id="exportBtn" style="display:none;">希望提出</button>
  </div>

  <div class="grid" id="grid"></div>
  <div id="version-label" style="text-align:left; margin:10px;">Ver.20250822</div>
  <div id="messageBox"></div>

<script>
  // iOSバウンス防止
  document.addEventListener('touchmove', e => { if (!e.target.closest('.grid')) e.preventDefault(); }, { passive:false });

  const grid = document.getElementById("grid");
  const memberNameSpan = document.getElementById("memberName");
  const targetDateSpan = document.getElementById("targetDate");
  const exportBtn = document.getElementById("exportBtn");
  const messageBox = document.getElementById("messageBox");
  const loadingText = document.getElementById("loadingText");
  const loadingSpinner = document.getElementById("loadingSpinner");

  const gasUrl = "https://script.google.com/macros/s/AKfycby-OWiC-DnfTcHVvEXqdVq0F3-NI4yQHqb8-Vw7iZH1gtPS7MbmP1x1YIhXbiNdPrEUCg/exec";
  const folderKeyword = "shift_adjustment_survey";

  const FILE_SUFFIX = "シフト希望";

  let allInputLines = [];
  let cellRefs = [];
  let year = '';
  let month = '';
  let targetYm = '';
  let highlightData = [];

  /* ★ 備考入力への参照 */
  let commonRemarkInput = null;
  const rowRemarkInputs = new Map(); // key: 表示上の行index（共通備考・日付・曜日を含む）

  const userName = localStorage.getItem("userName") || "未設定";
  memberNameSpan.textContent = userName;

  document.addEventListener("DOMContentLoaded", () => { showLoading("処理中..."); });

  function showLoading(msg){ loadingText.textContent = msg; loadingSpinner.style.display = "inline-block"; }
  function hideLoading(){ loadingText.textContent = ""; loadingSpinner.style.display = "none"; }
  function showMessage(msg, type='info'){ messageBox.className = `show ${type}`; messageBox.textContent = msg; setTimeout(()=>messageBox.classList.remove('show'),3000); }
  function parseCSVLine(line){ return line.split(',').map(s => s.trim()); }

  function initAllData(){
    showLoading("処理中...");
    fetch(`${gasUrl}?action=read&folder=${folderKeyword}&file=input_data.txt`)
      .then(res => res.text())
      .then(text => {
        allInputLines = text.split('\n').filter(l => l.trim());
        const ym = parseCSVLine(allInputLines[0]); // 年月,YYYY,MM
        year  = ym[1];
        month = ym[2];
        targetYm = `${year}${String(month).padStart(2,'0')}`;
        targetDateSpan.textContent = `対象：${year}年${month}月`;
        loadDataForMember(userName);
      })
      .catch(err => { showMessage("ヘッダ情報の読み込みに失敗しました。\n"+err.message,'error'); hideLoading(); });
  }

  function loadGridFromData(lines){
    grid.innerHTML = ''; cellRefs = []; rowRemarkInputs.clear(); commonRemarkInput = null;

    const data = lines.map(parseCSVLine);
    const baseRowCount = data.length;

    /* ★ 列数：日付31列 + 左の見出し1列 + 右端の備考1列 = 33 */
    const colCount = 33;

    const fragment = document.createDocumentFragment();

    /* ★ 先頭に「共通備考」行（表示上の行index=0）を追加 */
    {
      const row = [];
      for (let c=0; c<colCount; c++){
        const cell = document.createElement("div");
        cell.className = "cell header-0";
        if (c===0){
          cell.classList.add("fixed-col");
          cell.textContent = "共通備考";
        } else if (c===1){
          // 右側全域に1セルで広げて入力欄を配置
          cell.style.gridColumn = "2 / span 32";
          cell.style.textAlign = "left";
          const input = document.createElement("input");
          input.type = "text";
          input.className = "remark-input";
          input.setAttribute("size","50");     // 表示幅 50文字
          input.setAttribute("maxlength","50");// 入力可能 50文字
          input.placeholder = "（例）全体連絡事項などを記入";
          cell.appendChild(input);
          commonRemarkInput = input;
        } else {
          cell.style.display = "none"; // グリッド上は1セルで占有するため残りは非表示
        }
        fragment.appendChild(cell);
        row.push(cell);
      }
      cellRefs.push(row);
    }

    /* ★ 以降：元データの「日付」「曜日」「コース行」を順に描画 */
    for (let r=0; r<baseRowCount; r++){
      const row = [];
      for (let c=0; c<colCount; c++){
        const cell = document.createElement("div");
        cell.className = "cell";

        const isDateRow   = (r===0);
        const isWeekRow   = (r===1);
        const isDataRow   = (r>=2);
        const val = (c < 32) ? (data[r]?.[c] ?? '') : ''; // 右端の備考列（c=32）はデータ外

        if (c===0) cell.classList.add("fixed-col");

        if (isDateRow){
          cell.classList.add("header-1");
          cell.textContent = c>0 ? val : "日付";
        } else if (isWeekRow){
          cell.classList.add("header-2");
          if (c===32){
            cell.textContent = "コースごとの備考"; // ★ ヘッダ表示
          } else {
            cell.innerHTML = c>0 ? (['土','日'].includes(val) ? `<span class="red">${val}</span>` : val) : "曜日";
          }
        } else {
          if (c===32){
            // ★ 各データ行の右端に入力欄（表示幅30文字、最大50）
            const input = document.createElement("input");
            input.type = "text";
            input.className = "remark-input";
            input.setAttribute("size","30");
            input.setAttribute("maxlength","50");
            input.placeholder = "備考";
            cell.style.textAlign = "left";
            cell.appendChild(input);
            // 表示上の行index：共通備考(0) + 日付(1) + 曜日(1) を加味
            const displayRowIndex = 1 /*共通備考*/ + r + 1; // r=0→2, r=1→3, r=2→4...
            rowRemarkInputs.set(displayRowIndex, input);
          } else {
            cell.textContent = val;
            // クリックで赤トグルは日付・曜日以外＆日付列1..31のみ
            if (c>0 && c<32 && isDataRow && val!==""){ cell.onclick = () => handleCellClick(1 + r + 1, c, cell); }
          }
        }

        fragment.appendChild(cell);
        row.push(cell);
      }
      cellRefs.push(row);
    }

    grid.appendChild(fragment);
    applyHighlight();
    hideLoading();
  }

  function handleCellClick(rowIndex, colIndex, cell){
    if (cell.classList.contains("highlight-red")) cell.classList.remove("highlight-red");
    else cell.classList.add("highlight-red");
  }

  function applyHighlight(){
    if (!highlightData.length) return;
    // highlightData[0]: 回答者,xxx
    // highlightData[1]: 年月,YYYY,MM
    // highlightData[2]以降：元ファイルの「日付行, 曜日行, データ行...」
    // ★ 画面では先頭に共通備考行を1行追加しているため、表示行r=3以降がデータ行。
    for (let r=3; r<cellRefs.length; r++){
      // highlightData側の対応行は 2 + (r-1) = r+1
      const line = highlightData[r+1] || '';
      const row = line.split(',');
      for (let c=1; c<=31 && c<cellRefs[r].length; c++){
        if (row[c] === '1'){ cellRefs[r][c].classList.add("highlight-red"); }
      }
    }
  }

  function mergeInputAndOutput(inputLines, outputLines){
    highlightData = [...outputLines]; // "1" だけを参照
    const merged = [];
    // input_data.txt 構成：
    // 0: 年月,YYYY,MM
    // 1: 日付行
    // 2: 曜日行
    // 3以降: データ行（先頭セル=コース名）
    merged[0] = inputLines[1];  // 日付
    merged[1] = inputLines[2];  // 曜日
    for (let r=3; r<inputLines.length; r++){ merged.push(inputLines[r]); }
    return merged;
  }

  function loadDataForMember(member){
    showLoading("処理中...");
    const prefix = `${member}_`;
    const exactName = `${member}_${targetYm}${FILE_SUFFIX}.txt`;

    fetch(`${gasUrl}?action=list&folder=${folderKeyword}&prefix=${encodeURIComponent(prefix)}`)
      .then(res => res.json())
      .then(data => {
        const inputLines = allInputLines;
        const files = (data.result === "success" && Array.isArray(data.files)) ? data.files : [];
        const hasExact = files.includes(exactName);

        if (hasExact){
          fetch(`${gasUrl}?action=read&folder=${folderKeyword}&file=${encodeURIComponent(exactName)}`)
            .then(res => res.text())
            .then(outputText => {
              const outputLines = outputText.split('\n').filter(l => l.trim());
              const merged = mergeInputAndOutput(inputLines, outputLines);
              loadGridFromData(merged);
              exportBtn.style.display = 'inline-block';
            })
            .catch(err => { showMessage("ファイル読み込みに失敗しました。\n"+err.message,'error'); hideLoading(); });
        } else {
          const merged = [ inputLines[1], inputLines[2], ...inputLines.slice(3) ];
          loadGridFromData(merged);
          exportBtn.style.display = 'inline-block';
        }
      })
      .catch(err => { showMessage("ファイルチェックに失敗しました。\n"+err.message,'error'); hideLoading(); });
  }

  // ★ 保存：赤=1、右端備考と共通備考もCSVに出力（新しい最下段列として）
  exportBtn.addEventListener('click', () => {
    showLoading("処理中...");
    let csv = `回答者,${userName}\n年月,${year},${month}\n`;

    const rowCount = cellRefs.length;
    for (let r=1; r<rowCount; r++){ // r=0は共通備考行なのでCSV行には含めない
      const row = [];
      // c=0..32（0:コース名, 1..31:日付, 32:備考）
      for (let c=0; c<=32; c++){
        if (r <= 2){
          // r=1:日付行, r=2:曜日行
          if (r===2 && c===32){
            row.push("コースごとの備考"); // 見出し
          } else {
            // 既存のテキストを出力
            // 日付行の先頭セルは「日付」、曜日行の先頭セルは「曜日」
            row.push(cellRefs[r][c]?.textContent ?? '');
          }
        } else {
          if (c === 0) {
            row.push(cellRefs[r][0]?.textContent ?? ''); // コース名
          } else if (c >= 1 && c <= 31) {
            row.push(cellRefs[r][c]?.classList.contains("highlight-red") ? '1' : '');
          } else if (c === 32) {
            const input = rowRemarkInputs.get(r);
            row.push(input ? (input.value || '') : '');
          }
        }
      }
      csv += row.join(',') + '\n';
    }

    // 末尾に共通備考の専用行を追加（ヘッダ,値）
    const commonRemark = (commonRemarkInput && commonRemarkInput.value) ? commonRemarkInput.value : "";
    csv += `共通備考,${commonRemark}\n`;

    const filename = `${userName}_${targetYm}${FILE_SUFFIX}.txt`;

    fetch(`${gasUrl}?action=overwrite&folder=${folderKeyword}&filename=${encodeURIComponent(filename)}`, {
      method:'POST', body:csv, headers:{ 'Content-Type':'text/plain' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.result === 'success'){
        const op    = data.operation || 'create';
        const made  = data.created === true ? '（新規作成）' : (data.created === false ? '（上書き）' : '');
        const hits  = (typeof data.matched === 'number') ? `\n同名ヒット数：${data.matched}` : '';
        showMessage(`保存しました！\nファイル名：${filename}\n処理：${op}${made}${hits}`, 'success');
      } else {
        showMessage("保存エラー：" + data.message, 'error');
      }
      hideLoading();
    })
    .catch(err => { showMessage("通信エラー：" + err.message, 'error'); hideLoading(); });
  });

  window.onload = initAllData;
</script>
<script src="reload.js?v=20250724"></script>
</body>
</html>
