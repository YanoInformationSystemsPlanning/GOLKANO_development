<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>シフト調整ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>html, body { -webkit-text-size-adjust: 100%; }


    html, body { margin:0; padding:0; font-family:sans-serif; width:100vw; height:100vh; overflow:auto; overscroll-behavior:none; }
    .header-bar {
  display:flex; align-items:center; gap:.5em; padding:5px 10px;
  background:#f0f0f0; border-bottom:1px solid #ccc; font-size:14px;
  flex-wrap: nowrap; white-space: nowrap; overflow: hidden;
}
.header-bar > * { flex: 0 0 auto; }
#memberName { min-width:0; flex:1 1 auto; overflow:hidden; text-overflow:ellipsis; }
#targetDate { flex:0 0 auto; }
    button { padding:2px 6px; font-size:14px; cursor:pointer; }
    .status { font-weight:bold; color:red; display:inline-flex; align-items:center; gap:6px; }
    .spinner { border:3px solid #f3f3f3; border-top:3px solid red; border-radius:50%; width:14px; height:14px; animation:spin 1s linear infinite; display:none; }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

    /* 右端に「コースごとの備考」列（1.5倍の幅：48ch） */
    .grid { display:grid; grid-template-columns:110px repeat(31,36px) 48ch; grid-auto-rows:30px; min-width:max-content; -webkit-overflow-scrolling:touch; }
    .cell { border:1px solid #ccc; text-align:center; line-height:30px; white-space:nowrap; user-select:none; background:#fff; font-size:14px; overflow:hidden; }

    .header-1 { position:sticky; top:0; background:#eee; z-index:7; }  /* 日付 */
    .header-2 { position:sticky; top:30px; background:#eee; z-index:6; } /* 曜日 */
    .fixed-col { position:sticky; left:0; background:#f8f8f8; padding-left:2.5em; z-index:5; }
    .header-1.fixed-col, .header-2.fixed-col { background:#eee; z-index:8; }

    .highlight-red { background:red !important; color:#fff; }
    .red { color:red; }

    #messageBox { position:fixed; top:10px; right:10px; background:#333; color:#fff; padding:10px 20px; border-radius:5px; opacity:0; transition:opacity .3s; z-index:9999; pointer-events:none; }
    #messageBox.show { opacity:1; }
    #messageBox.success { background:#28a745; } #messageBox.error { background:#dc3545; } #messageBox.info { background:#007bff; }

    .remark-input { width:100%; box-sizing:border-box; height:32px; border:1px solid #bbb; padding:0 6px; font-size:16px; line-height:32px; }
    .remark-input::placeholder { color:#999; }
  
/* === Added: Course controls & buttons (display filter UI) === */
.course-controls { margin:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
#toggleDisplayBtn { padding:6px 10px; font-size:14px; border:1px solid #888; border-radius:6px; }
.course-buttons { display:flex; flex-wrap:wrap; gap:8px; }
.course-btn { padding:6px 10px; border:1px solid #888; border-radius:6px; background:#2ecc71; color:#000; font-weight:bold; cursor:pointer; }
.course-btn.selected { background:#e74c3c; color:#fff; }
</style>
</head>
<body>
  <button onclick="location.href='top_menu.html'">トップに戻る</button>

  <div class="header-bar">
    <span>回答者：</span><span id="memberName"></span>
    <span id="targetDate"></span>
    <span id="loadingStatus" class="status"><span id="loadingText"></span><span class="spinner" id="loadingSpinner"></span></span>
    <button id="exportBtn" style="display:none;">希望提出</button>
  </div>

  <div class="grid" id="grid"></div>
<!-- === Added: Display Toggle button and course name buttons container === -->
<div id="course-controls" class="course-controls">
  <button id="toggleDisplayBtn" type="button">表示切替</button>
  <div id="course-buttons" class="course-buttons" aria-label="コース名ボタン群"></div>
</div>

  <div id="version-label" style="text-align:left; margin:10px;">Ver.20250824c</div>
  <div id="messageBox"></div>

<script>
  document.addEventListener('touchmove', e => { if (!e.target.closest('.grid')) e.preventDefault(); }, { passive:false });

  const grid = document.getElementById("grid");
  const memberNameSpan = document.getElementById("memberName");
  const targetDateSpan = document.getElementById("targetDate");
  const exportBtn = document.getElementById("exportBtn");
  const messageBox = document.getElementById("messageBox");
  const loadingText = document.getElementById("loadingText");
  const loadingSpinner = document.getElementById("loadingSpinner");

  const gasUrl = "https://script.google.com/macros/s/AKfycby-OWiC-DnfTcHVvEXqdVq0F3-NI4yQHqb8-Vw7iZH1gtPS7MbmP1x1YIhXbiNdPrEUCg/exec";
  const folderKeyword = "shift_adjustment_survey";
  const FILE_SUFFIX = "シフト希望";

  let allInputLines = [];
  let cellRefs = [];
  let year = ''; let month = ''; let targetYm = '';
  let highlightData = [];
  let savedOutputLines = [];   // ★ 提出済みCSV（行配列のまま保持）
  const rowRemarkInputs = new Map();

  const userName = localStorage.getItem("userName") || "未設定";
  memberNameSpan.textContent = userName;

  document.addEventListener("DOMContentLoaded", () => { showLoading("処理中..."); });

  function showLoading(msg){ loadingText.textContent = msg; loadingSpinner.style.display = "inline-block"; }
  function hideLoading(){ loadingText.textContent = ""; loadingSpinner.style.display = "none"; }
  function showMessage(msg, type='info'){ messageBox.className = `show ${type}`; messageBox.textContent = msg; setTimeout(()=>messageBox.classList.remove('show'),3000); }
  function parseCSVLine(line){ return line.split(',').map(s => s.trim()); }

  function initAllData(){
    showLoading("処理中...");
    fetch(`${gasUrl}?action=read&folder=${folderKeyword}&file=input_data.txt`)
      .then(res => res.text())
      .then(text => {
        allInputLines = text.split('\n').filter(l => l.trim());
        const ym = parseCSVLine(allInputLines[0]); // 0: 年月,YYYY,MM
        year  = ym[1]; month = ym[2];
        targetYm = `${year}${String(month).padStart(2,'0')}`;
        targetDateSpan.textContent = `対象：${year}年${month}月`;
        loadDataForMember(userName);
      })
      .catch(err => { showMessage("ヘッダ情報の読み込みに失敗しました。\n"+err.message,'error'); hideLoading(); });
  }

  function loadGridFromData(lines){
    grid.innerHTML = ''; cellRefs = []; rowRemarkInputs.clear();

    const data = lines.map(parseCSVLine);        // テンプレ（input_data.txt）由来
    const baseRowCount = data.length;
    const colCount = 33; // 日付31 + 左見出し + 右端備考

    const fragment = document.createDocumentFragment();

    for (let r=0; r<baseRowCount; r++){
      const row = [];
      for (let c=0; c<colCount; c++){
        const cell = document.createElement("div");
        cell.className = "cell";

        const isDateRow = (r===0);
        const isWeekRow = (r===1);
        const isDataRow = (r>=2);
        const val = (c < 32) ? (data[r]?.[c] ?? '') : '';

        if (c===0) cell.classList.add("fixed-col");

        if (isDateRow){
          cell.classList.add("header-1");
          cell.textContent = c>0 ? val : "日付";
        } else if (isWeekRow){
          cell.classList.add("header-2");
          if (c===32){
            cell.textContent = "コースごとの備考";
          } else {
            cell.innerHTML = c>0 ? (['土','日'].includes(val) ? `<span class="red">${val}</span>` : val) : "曜日";
          }
        } else {
          if (c===32){
            // ★ 右端備考入力：幅1.5倍、placeholderは「コース名の備考」、さらに提出済み値を復元
            const courseName = data[r]?.[0] ? String(data[r][0]).trim() : "";
            const input = document.createElement("input");
            input.type = "text";
            input.className = "remark-input";
            input.setAttribute("size","75");       // 1.5倍幅
            input.setAttribute("maxlength","50");  // 上限は据え置き
            const ph = courseName ? `${courseName}の備考` : "備考";
            input.placeholder = ph;
            input.setAttribute("aria-label", ph);
            cell.style.textAlign = "left";
            cell.appendChild(input);

            // ★ 提出済みCSVから備考を復元（行ずれ対策：出力ファイルは先頭2行がヘッダ）
            const outIdx = r + 2; // 0:日付→2, 1:曜日→3, 2:最初のデータ行→4 ...
            if (savedOutputLines[outIdx]){
              const savedCols = savedOutputLines[outIdx].split(',');
              input.value = (savedCols[32] || '').trim();
            }

            rowRemarkInputs.set(r, input);
          } else {
            cell.textContent = val;
            if (c>0 && c<32 && isDataRow && val!==""){ cell.onclick = () => handleCellClick(r, c, cell); }
          }
        }

        fragment.appendChild(cell);
        row.push(cell);
      }
      cellRefs.push(row);
    }

    grid.appendChild(fragment);
    applyHighlight();
    hideLoading();
  }

  function handleCellClick(rowIndex, colIndex, cell){
    if (cell.classList.contains("highlight-red")) cell.classList.remove("highlight-red");
    else cell.classList.add("highlight-red");
  }

  function applyHighlight(){
    if (!highlightData.length) return;
    // ★ 行オフセット修正：提出CSVは [0]回答者, [1]年月, [2]日付, [3]曜日, [4]以降がデータ行
    for (let r=2; r<cellRefs.length; r++){
      const outIdx = r + 2; // ← 共通備考を廃止した現仕様に合わせて +2 に統一
      const line = highlightData[outIdx] || '';
      const row = line.split(',');
      for (let c=1; c<=31 && c<cellRefs[r].length; c++){
        if (row[c] === '1'){ cellRefs[r][c].classList.add("highlight-red"); }
      }
      // ※ 右端の備考は loadGridFromData 内で value 復元済み
    }
  }

  function mergeInputAndOutput(inputLines, outputLines){
    // ★ 提出済みCSVを保持（ハイライト＆備考復元に使用）
    savedOutputLines = outputLines.slice();
    highlightData    = outputLines.slice();

    // グリッド表示用はテンプレから（日付・曜日・テキストはテンプレを信頼）
    const merged = [];
    merged[0] = inputLines[1];  // 日付
    merged[1] = inputLines[2];  // 曜日
    for (let r=3; r<inputLines.length; r++){ merged.push(inputLines[r]); }
    return merged;
  }

  function loadDataForMember(member){
    showLoading("処理中...");
    const prefix = `${member}_`;
    const exactName = `${member}_${targetYm}${FILE_SUFFIX}.txt`;

    fetch(`${gasUrl}?action=list&folder=${folderKeyword}&prefix=${encodeURIComponent(prefix)}`)
      .then(res => res.json())
      .then(data => {
        const inputLines = allInputLines;
        const files = (data.result === "success" && Array.isArray(data.files)) ? data.files : [];
        const hasExact = files.includes(exactName);

        if (hasExact){
          fetch(`${gasUrl}?action=read&folder=${folderKeyword}&file=${encodeURIComponent(exactName)}`)
            .then(res => res.text())
            .then(outputText => {
              const outputLines = outputText.split('\n').filter(l => l.trim());
              const merged = mergeInputAndOutput(inputLines, outputLines);
              loadGridFromData(merged);
              exportBtn.style.display = 'inline-block';
            })
            .catch(err => { showMessage("ファイル読み込みに失敗しました。\n"+err.message,'error'); hideLoading(); });
        } else {
          // 新規：ハイライト/備考の既存は無い
          savedOutputLines = [];
          highlightData = [];
          const merged = [ inputLines[1], inputLines[2], ...inputLines.slice(3) ];
          loadGridFromData(merged);
          exportBtn.style.display = 'inline-block';
        }
      })
      .catch(err => { showMessage("ファイルチェックに失敗しました。\n"+err.message,'error'); hideLoading(); });
  }

  // 保存：赤=1、右端備考をCSVに出力（共通備考は廃止）
  exportBtn.addEventListener('click', () => {
    showLoading("処理中...");
    let csv = `回答者,${userName}\n年月,${year},${month}\n`;

    const rowCount = cellRefs.length;
    for (let r=0; r<rowCount; r++){
      const row = [];
      for (let c=0; c<=32; c++){
        if (r <= 1){
          if (r===1 && c===32){
            row.push("コースごとの備考");
          } else {
            row.push(cellRefs[r][c]?.textContent ?? '');
          }
        } else {
          if (c === 0) {
            row.push(cellRefs[r][0]?.textContent ?? '');
          } else if (c >= 1 && c <= 31) {
            row.push(cellRefs[r][c]?.classList.contains("highlight-red") ? '1' : '');
          } else if (c === 32) {
            const input = rowRemarkInputs.get(r);
            row.push(input ? (input.value || '') : '');
          }
        }
      }
      csv += row.join(',') + '\n';
    }

    const filename = `${userName}_${targetYm}${FILE_SUFFIX}.txt`;

    fetch(`${gasUrl}?action=overwrite&folder=${folderKeyword}&filename=${encodeURIComponent(filename)}`, {
      method:'POST', body:csv, headers:{ 'Content-Type':'text/plain' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.result === 'success'){
        const op    = data.operation || 'create';
        const made  = data.created === true ? '（新規作成）' : (data.created === false ? '（上書き）' : '');
        const hits  = (typeof data.matched === 'number') ? `\n同名ヒット数：${data.matched}` : '';
        showMessage(`保存しました！\nファイル名：${filename}\n処理：${op}${made}${hits}`, 'success');
      } else {
        showMessage("保存エラー：" + data.message, 'error');
      }
      hideLoading();
    })
    .catch(err => { showMessage("通信エラー：" + err.message, 'error'); hideLoading(); });
  });

  window.onload = initAllData;
</script>
<script src="reload.js?v=20250724"></script>

<script>
// iOS: 回転時の予期しないズーム抑止（viewport再適用＆フォーカス解除）
window.addEventListener('orientationchange', () => {
  const meta = document.querySelector('meta[name="viewport"]');
  if (meta) {
    meta.setAttribute('content', 'width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no');
  }
  if (document.activeElement && typeof document.activeElement.blur === 'function') {
    document.activeElement.blur();
  }
});
</script>


<script>
// === Added: Display filter logic (non-destructive; data not modified) ===
(function(){
  // Lazy get elements when DOM is ready
  function byId(id){ return document.getElementById(id); }

  function ensureReady(fn){
    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", fn, {once:true});
    } else {
      fn();
    }
  }

  ensureReady(function(){
    const gridEl = byId("grid");
    const controls = byId("course-controls");
    const btnWrap = byId("course-buttons");
    const toggleBtn = byId("toggleDisplayBtn");

    if (!gridEl || !controls || !btnWrap || !toggleBtn){
      // Required nodes missing; do nothing.
      return;
    }

    // Globals that may already exist in the page:
    // - cellRefs: 2D array of the grid cells [row][col]
    // We'll work gracefully if they don't exist.
    const hasCellRefs = (typeof cellRefs !== "undefined" && Array.isArray(cellRefs));
let courseList = [];                 // [{rowIndex, name}]
    const courseBtnMap = new Map();      // rowIndex -> button

    function setRowVisibility(rowIndex, visible){
      if (hasCellRefs){
        const row = cellRefs[rowIndex] || [];
        for (const cell of row){ if (cell && cell.style){ cell.style.display = visible ? "" : "none"; } }
      } else {
        // Fallback: hide by data-row attribute if present (not expected in original)
        const rowNodes = gridEl.querySelectorAll('[data-row="'+rowIndex+'"]');
        rowNodes.forEach(node => node.style.display = visible ? "" : "none");
      }
    }

    function renderCourseButtons(){
      btnWrap.innerHTML = "";
      courseBtnMap.clear();
      for (const {rowIndex, name} of courseList){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "course-btn";
        b.textContent = name || ("行" + rowIndex);
        b.addEventListener("click", () => {
          b.classList.toggle("selected");  // 赤(選択) <-> 緑(未選択)
        });
        btnWrap.appendChild(b);
        courseBtnMap.set(rowIndex, b);
      }
    }

    function applyFilterFromButtons(){
      // Always show header rows 0 and 1
      setRowVisibility(0, true);
      setRowVisibility(1, true);
      for (const {rowIndex} of courseList){
        const btn = courseBtnMap.get(rowIndex);
        const show = !!(btn && btn.classList.contains("selected"));
        setRowVisibility(rowIndex, show);
      }
    }

    if (toggleBtn){
      toggleBtn.addEventListener("click", function(){
        const ok = window.confirm("表示切替を行いますが宜しいですか。");
        if (!ok) return;
        applyFilterFromButtons();
      });
    }

    // --- Integration with existing grid build ---
    // If a global function loadGridFromData exists, wrap it to add our behavior.
    const origLoad = (typeof loadGridFromData === 'function') ? loadGridFromData : undefined;
    function buildButtonsFromCurrentGrid(){
      // Collect course names from the first column of data rows (r >= 2)
      courseList = [];
      if (hasCellRefs){
        for (let r = 2; r < cellRefs.length; r++){
          const firstCell = cellRefs[r] && cellRefs[r][0];
          const name = firstCell ? String(firstCell.textContent || "").trim() : "";
          courseList.push({ rowIndex: r, name });
        }
      } else {
        // Fallback: attempt to scan .cell elements (if class exists) - best-effort only
        const rows = Array.from(gridEl.querySelectorAll(".row"));
        for (let r = 2; r < rows.length; r++){
          const firstCell = rows[r].querySelector(".cell");
          const name = firstCell ? String(firstCell.textContent || "").trim() : "";
          courseList.push({ rowIndex: r, name });
        }
      }
      renderCourseButtons(); // initial: all green (未選択)
    }

    if (typeof origLoad === "function"){
      loadGridFromData = function(){
        // Call the original to construct the grid
        const ret = origLoad.apply(this, arguments);
        // After grid is constructed, gather names and render buttons
        try { buildButtonsFromCurrentGrid(); } catch(e){ /* no-op */ }
        return ret;
      };
    } else {
      // If no loader, attempt once after DOM ready (maybe grid already built statically)
      try { buildButtonsFromCurrentGrid(); } catch(e){ /* no-op */ }
    }
  });
})();
</script>
</body>
</html>
