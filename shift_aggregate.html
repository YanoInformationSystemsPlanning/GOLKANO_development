<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>シフト希望集約</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root { --fg:#222; --muted:#666; --ok:#28a745; --error:#d9534f; --primary:#2b7cff; }
    html,body { margin:0; padding:0; font-family:sans-serif; background:#f7f7f7; color:var(--fg); }
    header { display:flex; align-items:center; gap:10px; padding:10px; background:#f0f0f0; border-bottom:1px solid #ddd; }
    header h1 { font-size:18px; margin:0; }
    main { max-width:980px; margin:18px auto 48px; padding:0 12px; }
    .card { background:#fff; border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,.06); padding:16px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .btn {
      appearance:none; border:none; border-radius:8px; padding:10px 14px; font-size:15px; color:#fff; background:var(--primary);
      cursor:pointer;
    }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eee; color:#333; }
    #log { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "DejaVu Sans Mono", monospace; white-space:pre-wrap; font-size:12px; color:#333; margin-top:10px; }
    .msg { margin-top:12px; padding:10px 12px; border-radius:8px; font-size:14px; display:none; }
    .msg.ok { display:block; background:#e7f6ec; color:#0f5132; border:1px solid #badbcc; }
    .msg.error { display:block; background:#fdecea; color:#842029; border:1px solid #f5c2c0; }
    .spinner { width:14px; height:14px; border-radius:50%; border:2px solid #cdd; border-top-color:transparent; animation: spin 1s linear infinite; display:inline-block; vertical-align:-2px; margin-right:6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .note { font-size:12px; color:#555; margin-top:8px; }
    .list { margin-top:10px; font-size:13px; }
    .list code { background:#f4f4f4; padding:1px 6px; border-radius:6px; }
    .muted { color:var(--muted); }
  </style>
</head>
<body>
  <button onclick="location.href='top_menu.html'">トップに戻る</button>

  <header>
    <h1>シフト希望集約</h1>
    <span id="userInfo" class="pill"></span>
    <span id="status" class="muted" style="margin-left:auto;">準備完了</span>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <label for="yymm">対象年月(YYYYMM)</label>
        <input id="yymm" type="text" placeholder="202508" value="" inputmode="numeric" pattern="\\d{6}" style="padding:8px 10px; border-radius:8px; border:1px solid #ccc; width:110px;" />
        <button id="runBtn" class="btn">集約してCSV出力</button>
      </div>
      <div id="msg" class="msg" role="status" aria-live="polite"></div>
      <div id="fileInfo" class="note"></div>
      <pre id="log"></pre>

      <div class="note">
        ・対象フォルダ：<code>shift_adjustment_survey</code><br/>
        ・対象ファイル：<code>*_YYYYMMシフト希望.txt</code>（YYYYMM一致のみ）<br/>
        ・出力ファイル：<code>シフト希望集約_YYYYMM.csv</code>（上書き／無ければ新規）です。<br/>
        ・出力列パターン：<code>… C:コース名, D:"01,05,07,…", E:最終カラム, F:コース名, G:"…", H:最終カラム, …</code><br/>
        　※D/G/J…列は 31 項目で出力し、“1”の位置に日付（01〜31）、それ以外は空（例：<code>"01,,,,05,,07,,,,,,,,,,,,,,,,,,,,,,,,31"</code>）
      </div>
    </div>
  </main>

  <div id="version-label" style="text-align:left; margin:10px;">Ver.20250824e</div>

  <script>
    // ===== 設定 =====
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx_dummy/exec"; // ★差し替えてください
    const FOLDER  = "shift_adjustment_survey";

    // ===== 要素参照 =====
    const $run    = document.getElementById("runBtn");
    const $status = document.getElementById("status");
    const $log    = document.getElementById("log");
    const $msg    = document.getElementById("msg");
    const $fileInfo = document.getElementById("fileInfo");
    const $userInfo = document.getElementById("userInfo");

    // ===== 共通UI =====
    function setBusy(on, text) {
      $run.disabled = on;
      $status.innerHTML = on ? `<span class="spinner"></span>${text || "処理中…"}` : (text || "準備完了");
    }
    function info(text) { $msg.className = "msg ok";    $msg.textContent = text; $msg.style.display = "block"; }
    function err (text) { $msg.className = "msg error"; $msg.textContent = text; $msg.style.display = "block"; }
    function logln(t="") { $log.textContent += t + "\n"; }
    function clearLog()   { $log.textContent = ""; $msg.style.display = "none"; $msg.textContent = ""; }

    // ===== ログイン表示（任意） =====
    (function initUser(){
      const name = localStorage.getItem("userName") || "";
      const role = (localStorage.getItem("userRole") || "").toLowerCase();
      if (name) $userInfo.textContent = `${name}${role ? "（"+role+"）" : ""}`;
    })();

    // ===== Drive 一覧取得 → 対象抽出 =====
    async function listShiftFiles() {
      const url = `${GAS_URL}?action=list&folder=${encodeURIComponent(FOLDER)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Drive 一覧取得に失敗しました");
      const data = await res.json();
      if (!Array.isArray(data.files)) throw new Error("フォーマット不正（files）");
      return data.files;
    }

    // ===== Drive からテキスト取得 =====
    async function fetchTextFile(fileId) {
      const url = `${GAS_URL}?action=read&fileId=${encodeURIComponent(fileId)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("テキスト取得に失敗しました");
      const text = await res.text();
      return text.replace(/\r\n?|\n/g, "\n"); // 改行正規化
    }

    // === CSV クォート（Excel互換） ===
    function csvQuote(s) {
      return `"${String(s ?? "").replace(/"/g, '""')}"`;
    }

    // === 先頭から n 回目のカンマ位置を返す（見つからなければ -1） ===
    function nthCommaIndex(str, n) {
      let idx = -1;
      while (n-- > 0) {
        idx = str.indexOf(",", idx + 1);
        if (idx === -1) return -1;
      }
      return idx;
    }

    // === “1の立っている日（01〜31）” を31項目そのまま出力（非圧縮） ===
    function compactOnePositions(notLastStr) {
      // notLastStrは「日付1..31」のカンマ区切り（31項目想定）
      // ★ 非圧縮：31項目で出力し、“1”の位置には 01..31、それ以外は空文字
      const raw = String(notLastStr || "");
      const parts = raw.split(",");
      const out = [];
      for (let i = 0; i < 31; i++) {
        const v = (parts[i] || "").trim();
        out.push(v === "1" ? String(i + 1).padStart(2, "0") : "");
      }
      return out.join(","); // 例: "01,,,,05,,07,,,,,,,,,,,,,,,,,,,,,,,,31"
    }

    // ===== 1ファイル → 1行集約の生成（“最終カラム以外”を非圧縮形式で出力） =====
    function buildOneRow(yymm, filename, text) {
      // 行構造：
      // 0: 回答者,名前 / 1: 年月,YYYY,MM / 2: 日付,... / 3: 曜日,...
      // 4行目以降：コース名, [日付1..31], [最終カラム（備考 等／無い場合あり）]
      const rawLines = text.split("\n");
      const row = [];

      // 回答者名の推定
      const responder = (rawLines[0] && rawLines[0].startsWith("名前,"))
        ? (rawLines[0].split(",")[1] || "").trim()
        : filename.replace(/_.*$/, "");

      row.push(responder); // B列相当（CSVでは列順は後で固定）
      row.push(yymm);      // A列相当（出力時に順番整列）

      // 4行目以降を処理
      const last = rawLines.length - 1;
      for (let i = 4; i <= last; i++) {
        const line = rawLines[i] ?? "";
        const firstComma = line.indexOf(",");
        const sepAfterD31 = nthCommaIndex(line, 32); // 1（コース名後）+ 31（日付）= 32個目

        // コース名
        const course = (firstComma >= 0) ? line.slice(0, firstComma) : line;

        // “最終カラム以外”（日付1..31）と “最終カラム”（備考 等）
        let notLast = "";
        let lastCol = "";
        if (firstComma >= 0) {
          if (sepAfterD31 !== -1) {
            notLast = line.slice(firstComma + 1, sepAfterD31); // 日付1..31
            lastCol = line.slice(sepAfterD31 + 1);             // 末尾（備考 等／空可）
          } else {
            // 旧形式（備考列なし：日付1..31のみ）
            notLast = line.slice(firstComma + 1);
            lastCol = "";
          }
        }

        // ★ “1”の位置に日付を配置（非圧縮・31項目）
        const compressed = compactOnePositions(notLast);

        row.push(course);               // C, F, I, ...
        row.push(csvQuote(compressed)); // D, G, J, ...  ← 例 "01,,,,05,,07,,,,,,,,,,,,,,,,,,,,,,,,31"
        row.push(csvQuote(lastCol));    // E, H, K, ...
      }

      // 出力順に整形：[YYYYMM, 回答者, (C,D,E)×n]
      const yyyy = yymm.slice(0, 4);
      const mm   = yymm.slice(4, 6);

      const out = [];
      out.push(yymm);         // A列
      out.push(responder);    // B列
      for (let i = 2; i < row.length; i++) out.push(row[i]);

      return out.join(",");
    }

    // ===== CSV 全文を生成 =====
    function buildCsv(yymm, entries) {
      const lines = [];
      lines.push(`シフト希望集約_${yymm}`);
      for (const e of entries) {
        lines.push(buildOneRow(yymm, e.name, e.text));
      }
      return lines.join("\n") + "\n"; // 末尾改行
    }

    // ===== CSV 保存要求（GAS 側へ） =====
    async function saveAggregateCsv(yymm, csvText) {
      // UTF-8 BOMを付加
      const bom = "\uFEFF";
      const body = bom + csvText;

      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=UTF-8" },
        body: JSON.stringify({
          action: "save",
          folder: FOLDER,
          name: `シフト希望集約_${yymm}.csv`,
          content: body
        })
      });
      if (!res.ok) throw new Error("CSV 保存に失敗しました");
      const data = await res.json();
      return { outName: `シフト希望集約_${yymm}.csv`, api: data };
    }

    // ===== メイン処理 =====
    $run.addEventListener("click", async () => {
      clearLog();
      const yymm = (document.getElementById("yymm").value || "").trim();

      setBusy(true, "一覧取得中…");
      try {
        const files = await listShiftFiles();
        const targets = files.filter(f => new RegExp(`_${yymm}シフト希望\.txt$`).test(f.name));
        if (targets.length === 0) { throw new Error("対象ファイルが見つかりません"); }

        $fileInfo.textContent = `${targets.length} 件ヒット`;

        setBusy(true, "読込中…");
        const entries = [];
        for (const f of targets) {
          const text = await fetchTextFile(f.id);
          entries.push({ name: f.name, text });
        }

        setBusy(true, "CSV 生成中…");
        const csvText = buildCsv(yymm, entries);

        setBusy(true, "保存中…");
        const { outName, api } = await saveAggregateCsv(yymm, csvText);

        info(`完了：${outName}
処理：${api.operation}${api.created===true?"（新規作成）":api.created===false?"（上書き）":""}`);
        setBusy(false, "完了");
      } catch (e) {
        console.error(e);
        err(e.message || "エラーが発生しました。");
        setBusy(false, "待機中");
      }
    });
        }

        setBusy(true, "CSV 生成中…");
        const csvText = buildCsv(yymm, entries);

        setBusy(true, "保存中…");
        const { outName, api } = await saveAggregateCsv(yymm, csvText);

        info(`完了：${outName}\n処理：${api.operation}${api.created===true?"（新規作成）":api.created===false?"（上書き）":""}`);
        setBusy(false, "完了");
      } catch (e) {
        console.error(e);
        err(e.message || "エラーが発生しました。");
        setBusy(false, "待機中");
      }
    });
  </script>
  <script src="reload.js?v=20250724"></script>
</body>
</html>
