<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>シフト希望集約</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root { --fg:#222; --muted:#666; --ok:#28a745; --error:#d9534f; --primary:#2b7cff; }
    html,body { margin:0; padding:0; font-family:sans-serif; background:#f7f7f7; color:var(--fg); }
    header { display:flex; align-items:center; gap:10px; padding:10px; background:#f0f0f0; border-bottom:1px solid #ddd; }
    header h1 { font-size:18px; margin:0; }
    main { max-width:980px; margin:18px auto 48px; padding:0 12px; }
    .card { background:#fff; border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,.06); padding:16px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .btn {
      appearance:none; border:none; border-radius:8px; padding:10px 14px; font-size:15px; color:#fff; background:var(--primary);
      cursor:pointer;
    }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eee; color:#333; }
    #log { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space:pre-wrap; font-size:12px; color:#333; margin-top:10px; }
    .msg { margin-top:12px; padding:10px 12px; border-radius:8px; font-size:14px; display:none; }
    .msg.ok { display:block; background:#e7f6ec; color:#0f5132; border:1px solid #badbcc; }
    .msg.error { display:block; background:#fdecea; color:#842029; border:1px solid #f5c2c0; }
    .spinner { width:14px; height:14px; border-radius:50%; border:3px solid #eaeaea; border-top:3px solid var(--primary); animation:spin 1s linear infinite; display:inline-block; vertical-align:-2px; margin-right:6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .note { font-size:12px; color:#555; margin-top:8px; }
    .list { margin-top:10px; font-size:13px; }
    .list code { background:#f4f4f4; padding:1px 6px; border-radius:6px; }
    .muted { color:var(--muted); }
  </style>
</head>
<body>
  <button onclick="location.href='top_menu.html'">トップに戻る</button>

  <header>
    <h1>シフト希望集約</h1>
    <span id="userInfo" class="pill"></span>
    <span id="status" class="muted" style="margin-left:auto;">準備完了</span>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <button id="runBtn" class="btn">集約を実行</button>
      </div>
      <div id="msg" class="msg"></div>
      <div class="list" id="fileInfo"></div>
      <div id="log"></div>
      <div class="note">
        ・<code>shift_adjustment_survey</code> フォルダ直下の <code>*_YYYYMMシフト希望.txt</code> を対象にします。<br/>
        ・対象月（YYYYMM）が混在している場合はエラーで停止します。<br/>
        ・出力は <code>シフト希望集約_YYYYMM.csv</code>（上書き／無ければ新規）です。<br/>
        ・出力列パターン：<code>… C:コース名, D:"01,05,07,…", E:最終カラム, F:コース名, G:"…", H:最終カラム, …</code><br/>
        　※D/G/J…列は “1” の立っている日（01〜31）をカンマ区切りで格納（例：<code>"01,05,07,31"</code>）
      </div>
    </div>
  </main>

  <div id="version-label" style="text-align:left; margin:10px;">Ver.20250824d</div>

  <script>
    // ===== 設定 =====
    const GAS_URL = "https://script.google.com/macros/s/AKfycby-OWiC-DnfTcHVvEXqdVq0F3-NI4yQHqb8-Vw7iZH1gtPS7MbmP1x1YIhXbiNdPrEUCg/exec";
    const FOLDER  = "shift_adjustment_survey";

    // ===== 要素参照 =====
    const $run    = document.getElementById("runBtn");
    const $status = document.getElementById("status");
    const $log    = document.getElementById("log");
    const $msg    = document.getElementById("msg");
    const $fileInfo = document.getElementById("fileInfo");
    const $userInfo = document.getElementById("userInfo");

    // ===== 共通UI =====
    function setBusy(on, text) {
      $run.disabled = on;
      $status.innerHTML = on ? `<span class="spinner"></span>${text || "処理中…"}` : (text || "準備完了");
    }
    function info(text) { $msg.className = "msg ok";    $msg.textContent = text; $msg.style.display = "block"; }
    function err (text) { $msg.className = "msg error"; $msg.textContent = text; $msg.style.display = "block"; }
    function logln(t="") { $log.textContent += t + "\n"; }
    function clearLog()   { $log.textContent = ""; $msg.style.display = "none"; $msg.textContent = ""; }

    // ===== ログイン表示（任意） =====
    (function initUser(){
      const name = localStorage.getItem("userName") || "";
      const role = (localStorage.getItem("userRole") || "").toLowerCase();
      if (name) $userInfo.textContent = `${name}${role ? "（"+role+"）" : ""}`;
    })();

    // ===== Drive 一覧取得 → 対象抽出 =====
    async function listShiftFiles() {
      const url = `${GAS_URL}?action=list&folder=${encodeURIComponent(FOLDER)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`list 失敗: HTTP ${res.status}`);
      const data = await res.json();
      if (data.result !== "success" || !Array.isArray(data.files)) throw new Error("list 形式エラー");
      const rx = /_(\d{6})シフト希望\.txt$/;
      const targets = data.files.filter(n => rx.test(n));
      return { targets, rx };
    }

    // ===== YYYYMM 一致チェック =====
    function checkUniformYm(files, rx) {
      const ymSet = new Set();
      files.forEach(n => { const m = n.match(rx); if (m) ymSet.add(m[1]); });
      if (ymSet.size !== 1) {
        const list = [...ymSet].join(", ");
        throw new Error(`処理対象ファイルの対象月情報が正しくない（検出: ${list || "なし"}）`);
      }
      return [...ymSet][0];
    }

    // ===== 1ファイルのテキスト取得 =====
    async function fetchTextFile(name) {
      const url = `${GAS_URL}?action=read&folder=${encodeURIComponent(FOLDER)}&file=${encodeURIComponent(name)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`read 失敗: ${name} / HTTP ${res.status}`);
      return await res.text();
    }

    // === CSV クォート（Excel互換） ===
    function csvQuote(s) {
      return `"${String(s ?? "").replace(/"/g, '""')}"`;
    }

    // === 先頭から n 回目のカンマ位置を返す（見つからなければ -1） ===
    function nthCommaIndex(str, n) {
      let idx = -1;
      while (n-- > 0) {
        idx = str.indexOf(",", idx + 1);
        if (idx === -1) return -1;
      }
      return idx;
    }

    // === “1の立っている日（01〜31）” のCSV文字列へ圧縮 ===
    function compactOnePositions(notLastStr) {
      // notLastStrは「日付1..31」のカンマ区切り（31項目想定）
      const raw = String(notLastStr || "");
      const parts = raw.split(",");
      const out = [];
      for (let i = 0; i < 31; i++) {
        const v = (parts[i] || "").trim();
        if (v === "1") out.push(String(i + 1).padStart(2, "0"));
      }
      return out.join(","); // 例: "01,05,07,31"
    }

    // ===== 1ファイル → 1行集約の生成（“最終カラム以外”を圧縮して出力） =====
    function buildOneRow(yymm, filename, text) {
      // 行構造：
      // 0: 回答者,名前 / 1: 年月,YYYY,MM / 2: 日付,... / 3: 曜日,...
      // 4行目以降：コース名, [日付1..31], [最終列=備考 等]
      const rawLines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
      let last = rawLines.length - 1;
      while (last >= 0 && rawLines[last].trim() === "") last--;
      if (last < 4) throw new Error(`${filename}: 行数不足`);

      // 名前は先頭行 or ファイル名から
      const headCols = (rawLines[0] || "").split(",");
      const nameFromHead = headCols.length >= 2 ? headCols[1] : null;
      const nameFromFile = filename.split("_")[0];
      const member = nameFromHead || nameFromFile;

      const row = [ yymm, member ];

      for (let i = 4; i <= last; i++) {
        const line = rawLines[i] ?? "";
        const firstComma = line.indexOf(",");
        const sepAfterD31 = nthCommaIndex(line, 32); // 1（コース名後）+ 31（日付）= 32個目

        // コース名
        const course = (firstComma >= 0) ? line.slice(0, firstComma) : line;

        // “最終カラム以外”（日付1..31）と “最終カラム”（備考 等）
        let notLast = "";
        let lastCol = "";
        if (firstComma >= 0) {
          if (sepAfterD31 !== -1) {
            notLast = line.slice(firstComma + 1, sepAfterD31); // 日付1..31
            lastCol = line.slice(sepAfterD31 + 1);             // 末尾（備考 等／空可）
          } else {
            // 旧形式（備考列なし：日付1..31のみ）
            notLast = line.slice(firstComma + 1);
            lastCol = "";
          }
        }

        // ★ “1のある日だけ” を 2桁ゼロ詰めでCSV化
        const compressed = compactOnePositions(notLast);

        row.push(course);              // C, F, I, ...
        row.push(csvQuote(compressed)); // D, G, J, ...  ← 例 "01,05,07,31"
        row.push(csvQuote(lastCol));   // E, H, K, ...
      }

      return row.join(",");
    }

    // ===== すべて集約 → CSV テキスト（UTF-8 BOM付与でExcel文字化け防止） =====
    async function buildAggregateCsv(targets, yymm) {
      const header = `シフト希望集約_${yymm}`;
      const rows = [];
      for (const name of targets) {
        logln(`読込: ${name}`);
        const text = await fetchTextFile(name);
        rows.push(buildOneRow(yymm, name, text));
      }
      const BOM = "\uFEFF";
      return BOM + header + "\n" + rows.join("\n") + "\n";
    }

    // ===== CSV を Drive に保存（上書き or 新規） =====
    async function saveAggregateCsv(yymm, csvText) {
      const outName = `シフト希望集約_${yymm}.csv`;
      const url = `${GAS_URL}?action=overwrite&folder=${encodeURIComponent(FOLDER)}&filename=${encodeURIComponent(outName)}`;
      const res = await fetch(url, { method:"POST", headers:{ "Content-Type":"text/plain" }, body: csvText });
      if (!res.ok) throw new Error(`保存失敗: HTTP ${res.status}`);
      const data = await res.json();
      if (data.result !== "success") throw new Error(`保存エラー: ${data.message || "不明"}`);
      return { outName, api:data };
    }

    // ===== 画面：対象一覧の表示 =====
    function renderTargetList(files, yymm) {
      const $fileInfo = document.getElementById("fileInfo");
      if (!files.length) { $fileInfo.textContent = "対象ファイルはありません。"; return; }
      const html = [
        `<div><b>対象月:</b> ${yymm}</div>`,
        `<div><b>対象ファイル (${files.length}件):</b></div>`,
        "<ul style='margin:6px 0 0 18px;padding:0;'>",
        ...files.map(n => `<li style="margin:2px 0;"><code>${n}</code></li>`),
        "</ul>"
      ].join("");
      $fileInfo.innerHTML = html;
    }

    // ===== 実行ボタン =====
    document.getElementById("runBtn").addEventListener("click", async () => {
      clearLog(); setBusy(true, "一覧取得中…");
      try {
        // 1) 一覧
        const { targets, rx } = await listShiftFiles();
        if (!targets.length) { err("処理対象（*_YYYYMMシフト希望.txt）が見つかりません。"); setBusy(false, "待機中"); return; }

        // 2) YYYYMM 一致チェック
        const yymm = checkUniformYm(targets, rx);
        renderTargetList(targets, yymm);

        // 3) 集約
        setBusy(true, "集約中…");
        const csvText = await buildAggregateCsv(targets, yymm);

        // 4) 保存（上書き／なければ新規）
        setBusy(true, "保存中…");
        const { outName, api } = await saveAggregateCsv(yymm, csvText);

        info(`完了：${outName}\n処理：${api.operation}${api.created===true?"（新規作成）":api.created===false?"（上書き）":""}`);
        setBusy(false, "完了");
      } catch (e) {
        console.error(e);
        err(e.message || "エラーが発生しました。");
        setBusy(false, "待機中");
      }
    });
  </script>
  <script src="reload.js?v=20250724"></script>
</body>
</html>
