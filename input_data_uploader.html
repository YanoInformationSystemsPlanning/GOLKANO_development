<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>シフト調整アンケート用入力データエディタ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root { --accent:#007bff; --muted:#f0f0f0; }
    html,body { margin:0; padding:0; font-family:system-ui, sans-serif; background:#fff; color:#222; }
    header { position:sticky; top:0; background:var(--muted); border-bottom:1px solid #ccc; padding:8px 12px; display:flex; align-items:center; gap:.5rem; }
    header h1 { font-size:16px; margin:0; flex:1; }
    main { padding:12px; }
    .toolbar { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .toolbar h2 { margin:0; font-size:15px; }
    .spacer { flex:1; }
    button { cursor:pointer; padding:6px 10px; border:1px solid #bbb; background:#fff; border-radius:6px; }
    button.primary { border-color:var(--accent); }
    textarea { width:100%; box-sizing:border-box; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:14px; line-height:1.3; }
    .notice { margin-top:8px; font-size:13px; color:#555; }
    #messageBox { position:fixed; right:12px; top:12px; background:#333; color:#fff; padding:10px 16px; border-radius:8px;
                  opacity:0; transform:translateY(-8px); transition:.25s; pointer-events:none; white-space:pre-line; }
    #messageBox.show { opacity:1; transform:translateY(0); }
    #messageBox.success { background:#28a745; } #messageBox.error { background:#dc3545; } #messageBox.info { background:#007bff; }

    /* スピナー */
    #spinnerOverlay {
      position: fixed; inset: 0; background: rgba(255,255,255,0.65);
      display: none; place-items: center; z-index: 9999;
      backdrop-filter: blur(2px);
    }
    #spinnerOverlay.show { display: grid; }
    .spinner {
      width: 48px; height: 48px; border: 5px solid #ddd; border-top-color: #007bff;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header>
    <button id="backBtn">トップに戻る</button>
    <h1>シフト調整アンケート データ編集</h1>
  </header>

  <main>
    <div class="toolbar">
      <h2>シフト調整アンケート用入力データ</h2>
      <div class="spacer"></div>
      <button id="applyBtn" class="primary">データ反映</button>
    </div>

    <!-- 横100文字×縦35行／placeholderは入力開始で消える -->
    <textarea id="inputArea" cols="100" rows="35" placeholder="# Excelの要請数一覧シートの「シフト調整アンケート用入力データ」をコピーして貼り付けてください。
# 入力データは次のような内容になります。
# 年月,YYYY,MM
# 日付,01,02,03,04,05,06,07,08,09,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31
# 曜日,水,木,金,土,日,月,火,水,木,金,土,日,月,火,水,木,金,土,日,月,火,水,木,金,土,日,月,火,水,木,金
# コース名,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
# コース名,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
# コース名,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,"></textarea>

    <div class="notice">
      ・「データ反映」＝ Google Apps Script 経由で Google Drive 内
      <code>shift_adjustment_survey</code> フォルダへ <code>input_data.txt</code> を上書き保存します。
    </div>
  </main>

  <div id="messageBox" role="status" aria-live="polite"></div>

  <!-- スピナー -->
  <div id="spinnerOverlay" aria-hidden="true" aria-label="処理中">
    <div class="spinner" aria-role="progressbar"></div>
  </div>

  <script>
    // === 設定 ===
    const gasUrl = "https://script.google.com/macros/s/AKfycby-OWiC-DnfTcHVvEXqdVq0F3-NI4yQHqb8-Vw7iZH1gtPS7MbmP1x1YIhXbiNdPrEUCg/exec";
    const folderKeyword = "shift_adjustment_survey";
    const targetFilename = "input_data.txt";
    const MESSAGE_DURATION_MS = 7000; // 7秒キープ

    const backBtn     = document.getElementById("backBtn");
    const applyBtn    = document.getElementById("applyBtn");
    const inputArea   = document.getElementById("inputArea");
    const messageBox  = document.getElementById("messageBox");
    const spinner     = document.getElementById("spinnerOverlay");

    backBtn.addEventListener("click", () => {
      if (history.length > 1) history.back(); else location.href = "top_menu.html";
    });

    let messageTimer = null;
    function showMessage(msg, type = "info") {
      if (messageTimer) { clearTimeout(messageTimer); messageTimer = null; }
      messageBox.className = `show ${type}`;
      messageBox.textContent = msg;
      messageTimer = setTimeout(() => {
        messageBox.classList.remove("show");
        messageTimer = null;
      }, MESSAGE_DURATION_MS);
    }

    // 先頭の「年月,YYYY,MM」を抽出（コメントで始まる行は無視）
    function parseYYYYMMFromFirstLine(text) {
      const lines = text.split(/\r?\n/);
      const firstNonComment = (lines.find(l => l.trim() !== "" && !l.trim().startsWith("#")) || "").trim();
      const parts = firstNonComment.split(",").map(s => s.trim());
      if (parts.length >= 3 && parts[0] === "年月") {
        const y = parts[1];
        const m = String(parts[2]).padStart(2, "0");
        if (/^\d{4}$/.test(y) && /^\d{2}$/.test(m)) return { y, m };
      }
      return null;
    }

    function setBusy(busy) {
      if (busy) {
        spinner.classList.add("show");
        spinner.setAttribute("aria-hidden", "false");
        applyBtn.disabled = true;
        backBtn.disabled = true;
      } else {
        spinner.classList.remove("show");
        spinner.setAttribute("aria-hidden", "true");
        applyBtn.disabled = false;
        backBtn.disabled = false;
      }
    }

    applyBtn.addEventListener("click", async () => {
      const bodyText = inputArea.value || "";
      if (!bodyText.trim()) {
        showMessage("入力データが空です。", "error");
        return;
      }
      const ym = parseYYYYMMFromFirstLine(bodyText);
      if (!ym) {
        showMessage('先頭行に「年月,YYYY,MM」の形式で年月を記載してください。', "error");
        return;
      }

      const url = `${gasUrl}?action=overwrite&folder=${encodeURIComponent(folderKeyword)}&filename=${encodeURIComponent(targetFilename)}`;

      try {
        setBusy(true); // スピナーON
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: bodyText
        });
        const data = await res.json().catch(() => ({}));

        if (data && data.result === "success") {
          showMessage(`${ym.y}年${ym.m}月対応 シフト調整アンケート用入力データ作成が完了しました。`, "success");
        } else {
          const msg = (data && data.message) ? data.message : "不明なエラー";
          showMessage("保存に失敗しました：" + msg, "error");
        }
      } catch (err) {
        showMessage("通信エラー：" + err.message, "error");
      } finally {
        setBusy(false); // スピナーOFF
      }
    });
  </script>
</body>
</html>
