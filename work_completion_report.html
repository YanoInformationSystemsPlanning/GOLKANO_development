<script>
  (function(){
    const VERSION = 'Ver.2025-09-06c';
    const GAS_DEPLOY_ID = 'AKfycbxrnvzng88PDqgnubPyHC1n82EXZn8_zHU9EoAL922BcKwDc4QamCtQlpiaSwdWwS3mNg';
    const GAS_BASE_URL = `https://script.google.com/macros/s/${GAS_DEPLOY_ID}/exec`;

    const FOLDERS = {
      jobInformation: 'job_information',
      workCompletion: 'work_completion_report',
    };

    const els = {
      backBtn: document.getElementById('backBtn'),
      versionText: document.getElementById('versionText'),
      userInfoText: document.getElementById('userInfoText'),
      dateInput: document.getElementById('dateInput'),
      startBtn: document.getElementById('startBtn'),
      submitBtn: document.getElementById('submitBtn'),
      formArea: document.getElementById('formArea'),
      courseInput: document.getElementById('courseInput'),
      workInput: document.getElementById('workInput'),
      ticketInput: document.getElementById('ticketInput'),
      reportInput: document.getElementById('reportInput'),
      praiseInput: document.getElementById('praiseInput'),
      msg: document.getElementById('msg'),
      status: document.getElementById('status'),
    };

    // ===== Utils =====
    function yyyymmddJST(date=new Date()){
      const tz = 9 * 60; // minutes
      const t = date.getTime() + (date.getTimezoneOffset() + tz) * 60000;
      const d = new Date(t);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}${m}${da}`;
    }
    function showMsg(text, cls=''){
      els.msg.className = 'msg ' + (cls||'');
      els.msg.textContent = text || '';
    }
    function setBusy(on){
      els.status.innerHTML = on ? `<span class="spinner" aria-label="読み込み中"></span> 処理中…` : '';
    }
    function confirmBox(message){ return window.confirm(message); }

    // --- form helpers ---
    function autoGrow(textarea){
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(240, Math.max(38, textarea.scrollHeight)) + 'px';
    }
    function hydrateAutoGrow(){
      [els.reportInput, els.praiseInput].forEach(t => {
        if(!t) return;
        t.addEventListener('input', () => autoGrow(t));
        setTimeout(() => autoGrow(t), 0);
      });
    }
    function setFormVisible(on){
      els.formArea.classList.toggle('hidden', !on);
      els.submitBtn.disabled = !on;
    }
    function clearForm(){
      els.courseInput.value = '';
      els.workInput.value = '';
      els.ticketInput.value = '';
      els.reportInput.value = '';
      els.praiseInput.value = '';
      hydrateAutoGrow();
    }
    function fillFormFromJobInfoRow(row){
      // row: [メンバ名, 2列目, 3列目, 4列目(対象コース), ...]
      const course = (row && row[3]) ? String(row[3]).trim() : '';
      els.courseInput.value = course;
      els.workInput.value = '';
      els.ticketInput.value = '';
      els.reportInput.value = '';
      els.praiseInput.value = '';
      hydrateAutoGrow();
    }

    // --- CSV（読込用シンプル） ---
    function parseCsv(text){
      const rows = [];
      let i = 0, field = '', row = [], inQuote = false;
      const pushField = () => { row.push(field); field=''; };
      const pushRow = () => { rows.push(row); row=[]; };
      const s = String(text||'').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      while(i < s.length){
        const ch = s[i++];
        if(inQuote){
          if(ch === '"'){
            if(s[i] === '"'){ field += '"'; i++; }
            else { inQuote = false; }
          } else { field += ch; }
        } else {
          if(ch === '"'){ inQuote = true; }
          else if(ch === ','){ pushField(); }
          else if(ch === '\n'){ pushField(); pushRow(); }
          else { field += ch; }
        }
      }
      if(field.length>0 || row.length>0){ pushField(); pushRow(); }
      return rows;
    }

    // ===== GAS helpers =====
    async function gasGet(params){
      const url = new URL(GAS_BASE_URL);
      Object.entries(params||{}).forEach(([k,v]) => url.searchParams.set(k, v));
      const res = await fetch(url.toString(), { method: 'GET', cache: 'no-cache' });
      if(!res.ok) throw new Error(`GAS GET ${res.status}`);
      const ct = res.headers.get('content-type') || '';
      if(ct.includes('application/json')) return res.json();
      return res.text();
    }
    async function gasPost(params, body){
      const url = new URL(GAS_BASE_URL);
      Object.entries(params||{}).forEach(([k,v]) => url.searchParams.set(k, v));
      const res = await fetch(url.toString(), {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body,
      });
      if(!res.ok) throw new Error(`GAS POST ${res.status}`);
      const ct = res.headers.get('content-type') || '';
      if(ct.includes('application/json')) return res.json();
      return res.text();
    }
    async function listFiles(folder){ return gasGet({ action: 'list', folder }); }
    async function readFile(folder, file){ return gasGet({ action: 'read', folder, file }); }
    async function overwriteFile(folder, filename, content){
      // Excel対策：BOM + CRLF
      const CRLF = '\r\n';
      const txt = content.replace(/\r?\n/g, CRLF);
      const withBom = '\uFEFF' + txt;
      return gasPost({ action: 'overwrite', folder, filename }, withBom);
    }

    // ===== Domain helpers =====
    function requireYyyymmdd(v){ return /^\d{8}$/.test(v); }
    function getUserName(){ return localStorage.getItem('userName') || ''; }
    function getUserRole(){ return localStorage.getItem('userRole') || ''; }
    function targetReportName(date8, userName){ return `${date8}_${userName}_業務終了報告.csv`; }
    function jobInfoName(date8){ return `${date8}_業務連絡.csv`; }

    function fillFormFromReportCsv(csv){
      // 1行目: yyyymmdd,メンバ名,"業務終了報告"
      // 2行目以降: "見出し", 値
      const rows = parseCsv(csv);
      const map = new Map();
      for(let i=1;i<rows.length;i++){
        const r = rows[i];
        if(!r || r.length < 2) continue;
        map.set((r[0]||'').replace(/^\"|\"$/g,''), r[1]||'');
      }
      els.courseInput.value = map.get('対象コース') || '';
      els.workInput.value   = map.get('実施業務') || '';
      els.ticketInput.value = map.get('チョコ券枚数') || '';
      els.reportInput.value = map.get('報告事項') || '';
      els.praiseInput.value = map.get('お客様から褒められたこと') || '';
      hydrateAutoGrow();
    }

    async function tryReadExistingReport(date8, userName){
      const filename = targetReportName(date8, userName);
      try {
        // 誤判定防止：まず一覧で存在確認
        const list = await listFiles(FOLDERS.workCompletion);
        if(!Array.isArray(list) || !list.includes(filename)) return null;

        const txt = await readFile(FOLDERS.workCompletion, filename);
        if(typeof txt !== 'string') return null;
        const trimmed = txt.trim();
        if(!trimmed) return null;
        if(/^\{/.test(trimmed)){
          try{ const j = JSON.parse(trimmed); if(j && j.error) return null; }catch(_){/* not JSON */ }
        }
        if(/not\s*found|エラー|不存在|404/i.test(trimmed)) return null;
        return txt;
      } catch(e){
        return null; // 無ければ null
      }
    }

    async function loadJobInformation(date8){
      const filename = jobInfoName(date8);
      try {
        const txt = await readFile(FOLDERS.jobInformation, filename);
        return typeof txt === 'string' ? txt : '';
      } catch(e){
        return '';
      }
    }

    function findRowForUser(csvText, userName){
      const rows = parseCsv(csvText);
      for(const r of rows){
        if(!r || r.length === 0) continue;
        if(String(r[0]||'').trim() === String(userName||'').trim()){
          return r; // 該当行
        }
      }
      return null;
    }

    function buildOutputCsv(date8, userName){
      const CRLF = '\r\n';
      const esc = (s)=>{ s=(s??'').toString(); return '"'+ s.replace(/"/g,'""') +'"'; };
      const lines = [];
      lines.push([date8, userName, esc('業務終了報告')].join(','));
      lines.push([esc('対象コース'), esc(els.courseInput.value)].join(','));
      lines.push([esc('実施業務'), esc(els.workInput.value)].join(','));
      lines.push([esc('チョコ券枚数'), esc(els.ticketInput.value)].join(','));
      lines.push([esc('報告事項'), esc(els.reportInput.value)].join(','));
      lines.push([esc('お客様から褒められたこと'), esc(els.praiseInput.value)].join(','));
      return '\uFEFF' + lines.join(CRLF) + CRLF; // BOM + CRLF
    }

    function validateBeforeSubmit(){
      if(!/^\d+$/.test((els.ticketInput.value||'').trim())){
        alert('チョコ券枚数は 0 以上の半角数字で入力してください。');
        return false;
      }
      if((els.reportInput.value||'').trim() === ''){
        alert('報告事項が未入力です。');
        return false;
      }
      if((els.praiseInput.value||'').trim() === ''){
        alert('お客様から褒められたことが未入力です。');
        return false;
      }
      return true;
    }

    // ===== init & events =====
    els.backBtn.addEventListener('click', () => { window.location.href = 'top_menu.html'; });

    els.versionText.textContent = VERSION;
    const uName = getUserName() || '未ログイン';
    const role = getUserRole();
    els.userInfoText.textContent = role ? `${uName}(${role})` : uName;

    els.dateInput.value = yyyymmddJST();
    hydrateAutoGrow();

    // 「業務終了報告」押下
    els.startBtn.addEventListener('click', async () => {
      showMsg('');
      const date8 = (els.dateInput.value||'').trim();
      if(!requireYyyymmdd(date8)){
        showMsg('日付は yyyymmdd の8桁で入力してください。', 'error');
        return;
      }
      const userName = getUserName();
      if(!userName){
        showMsg('ログイン情報（userName）が見つかりません。index.html でログインしてください。', 'error');
        return;
      }

      setBusy(true);
      try {
        const existingCsv = await tryReadExistingReport(date8, userName);
        if(existingCsv){
          const ok = confirmBox('報告済みですが、修正しますか。');
          if(!ok){ setBusy(false); return; }
          setFormVisible(true);
          clearForm();
          fillFormFromReportCsv(existingCsv);
          showMsg('既存の内容を読み込みました。');
          setBusy(false);
          return;
        }

        const ok = confirmBox('新規報告ですね。');
        if(!ok){ setBusy(false); return; }

        const jobInfo = await loadJobInformation(date8);
        if(!jobInfo){
          alert('終了報告すべき業務はありません。');
          setBusy(false); return;
        }
        const row = findRowForUser(jobInfo, userName);
        if(!row || !row[3] || String(row[3]).trim()===''){
          alert('終了報告すべき業務はありません。');
          setBusy(false); return;
        }
        setFormVisible(true);
        clearForm();
        fillFormFromJobInfoRow(row);
        showMsg('入力フォームを初期化しました。');
      } catch(err){
        console.error(err);
        showMsg('処理中にエラーが発生しました。通信状況をご確認ください。', 'error');
      } finally {
        setBusy(false);
      }
    });

    // 「報告提出」押下
    els.submitBtn.addEventListener('click', async () => {
      const date8 = (els.dateInput.value||'').trim();
      if(!requireYyyymmdd(date8)){
        showMsg('日付は yyyymmdd の8桁で入力してください。', 'error');
        return;
      }
      const userName = getUserName();
      if(!userName){
        showMsg('ログイン情報（userName）が見つかりません。index.html でログインしてください。', 'error');
        return;
      }
      if(!validateBeforeSubmit()) return;

      const filename = targetReportName(date8, userName);
      const csv = buildOutputCsv(date8, userName);
      setBusy(true);
      try{
        await overwriteFile(FOLDERS.workCompletion, filename, csv);
        showMsg(`『${filename}』として保存しました。`, 'ok');
      } catch(err){
        console.error(err);
        alert('保存に失敗しました。時間をおいて再度お試しください。');
      } finally {
        setBusy(false);
      }
    });

  })();
</script>
</body>
</html>
