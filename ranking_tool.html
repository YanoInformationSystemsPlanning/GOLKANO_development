<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>順位決め</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    body { font-family: sans-serif; text-align: center; margin: 1em; }
    #version-label {
      position: absolute;
      top: 0.2em;
      left: 0.2em;
      font-size: 0.8em;
      color: #555;
    }
    #content-wrapper { margin-top: 1em; }
    h2 { margin-bottom: 0.5em; }
    #purpose-area { margin-bottom: 0.5em; }
    #select-area {
      display: flex; flex-wrap: wrap; justify-content: center;
      gap: 8px; margin-bottom: 1.5em; min-height: 3em;
    }
    .select-btn {
      padding: 0.6em 1em; border-radius: 6px; border: 1px solid #888;
      background-color: white; font-size: 1em; max-width: 8em;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .select-btn.small-text { font-size: 0.85em; }
    .select-btn.selected { background-color: limegreen; color: white; }
    #rank-button {
      font-size: 1.2em; background-color: red; color: white;
      padding: 0.6em 1.5em; border: none; border-radius: 5px;
      cursor: pointer; margin-bottom: 0.5em;
    }
    #result-area { text-align: left; margin-left: 1.0em; display: inline-block; }

    .loading-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: bold;
      color: red;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid red;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <button onclick="location.href='top_menu.html'">トップに戻る</button>

  <div id="version-label">Ver.20250903</div>
  <div id="content-wrapper">
    <div id="purpose-area">
      <label for="purpose-input"><strong>目的：</strong></label>
      <input id="purpose-input" type="text" maxlength="30"
       style="width: 90%; max-width: 35em; font-size: 1.0em;"
       placeholder="入力例：mm/dd コース名 キャンセル対象者抽選">
    </div>

    <h2>候補者一覧（五十音順）</h2>
    <div id="select-area">
      <div class="loading-status">
        <span>読み込み中...</span>
        <span class="spinner"></span>
      </div>
    </div>
    <button id="rank-button" onclick="generateRanking()">順位決め</button>
    <div style="width: 100%;"></div>
    <div id="result-area" style="margin-top: 0;"></div>
  </div>

  <script>
    // ===== データ取得設定 =====
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzh4fi1uShyFDZLsGr0F8cduWNqacUTpmIYFZ5VBrC1qbPkzIa8YPDzrlF5_n9N-hVRBg/exec";
    const MASTER_FOLDER = "master_data";
    const IDPW_FILE = "id_pw_list.txt";

    // 候補者リスト（{name, yomi} の配列）
    let CANDIDATES = [];

    // 起動時に候補者を1回だけ取得
    async function initCandidates() {
      const area = document.getElementById("select-area");
      try {
        const url = `${GAS_URL}?action=read&folder=${encodeURIComponent(MASTER_FOLDER)}&file=${encodeURIComponent(IDPW_FILE)}`;
        const response = await fetch(url, { cache: "no-store" });
        if (!response.ok) throw new Error(`HTTPエラー ${response.status}`);
        const text = await response.text();

        // id_pw_list.txt は「氏名,ID,PW,権限,よみがな」形式を想定
        CANDIDATES = text
          .split(/\r?\n/)
          .map(l => l.trim())
          .filter(l => l && !l.startsWith("#") && l.includes(","))
          .map(l => {
            const cols = l.split(",");
            return {
              name: cols[0]?.trim(),
              yomi: cols[4]?.trim() || cols[0]?.trim() // 読み仮名がなければ氏名を代用
            };
          })
          .filter(obj => !!obj.name);

        // 読み仮名でソート（五十音順）
        const collator = new Intl.Collator("ja");
        CANDIDATES.sort((a, b) => collator.compare(a.yomi, b.yomi));

        renderCandidates();
      } catch (e) {
        area.innerHTML = `<span style="color:red;">データ取得エラー: ${e.message}</span>`;
      }
    }

    // 候補者ボタンを生成
    function renderCandidates() {
      const area = document.getElementById("select-area");
      area.innerHTML = '';
      const fragment = document.createDocumentFragment();
      CANDIDATES.forEach(obj => {
        const btn = document.createElement("button");
        btn.textContent = obj.name;
        btn.className = "select-btn";
        if (obj.name.length > 4) btn.classList.add("small-text");
        btn.onclick = () => btn.classList.toggle("selected");
        fragment.appendChild(btn);
      });
      area.appendChild(fragment);
    }

    // 「順位決め」クリック処理
    function generateRanking() {
      const resultArea = document.getElementById("result-area");
      const rankBtn = document.getElementById("rank-button");

      rankBtn.disabled = true;
      resultArea.innerHTML = `
        <div class="loading-status">
          <span>処理中...</span>
          <span class="spinner"></span>
        </div>
      `;

      setTimeout(() => {
        showRankingResult();
        rankBtn.disabled = false;
      }, 3000);
    }

    // 結果表示
    function showRankingResult() {
      const selected = Array.from(document.getElementsByClassName("select-btn"))
        .filter(btn => btn.classList.contains("selected"))
        .map(btn => btn.textContent);

      const ordered = CANDIDATES.filter(obj => selected.includes(obj.name)).map(obj => obj.name);
      const shuffled = shuffle([...ordered]);
      const purpose = document.getElementById("purpose-input").value.trim();
      const resultArea = document.getElementById("result-area");
      resultArea.innerHTML = "";

      if (purpose) resultArea.innerHTML += `<div style="margin-bottom:0.5em;"><strong>目的：</strong>${purpose}</div>`;
      resultArea.innerHTML += `<h3 style="margin-bottom: 0.2em;">結果一覧</h3>`;
      shuffled.forEach((name, index) => {
        resultArea.innerHTML += `<div>${index + 1}位：${name}</div>`;
      });

      const now = new Date();
      const formatted = `${now.getFullYear()}年${String(now.getMonth()+1).padStart(2,'0')}月${String(now.getDate()).padStart(2,'0')}日 ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      resultArea.innerHTML += `<div style="margin-top:0.5em; font-size:1em;">実施：${formatted}</div>`;
    }

    // シャッフル関数
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const r = Math.floor(Math.random() * (i + 1));
        [array[i], array[r]] = [array[r], array[i]];
      }
      return array;
    }

    function adjustContentMargin() {
      const version = document.getElementById('version-label');
      const wrapper = document.getElementById('content-wrapper');
      const height = version.offsetHeight;
      wrapper.style.marginTop = (height * 1.2) + 'px';
    }

    window.onload = function() {
      initCandidates();
      adjustContentMargin();
    };
  </script>
  <script src="reload.js?v=20250724"></script>
</body>
</html>


