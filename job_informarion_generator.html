<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>業務連絡生成</title>
  <!-- iPhoneズーム抑止 -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --fg:#222;--muted:#666;--primary:#2b7cff;--tbl:#e5e5e5;--thead:#f8fbff;--bg:#f7f7f7;
      --px:8px;  /* セル左右padding */
      --bw:1px;  /* セル左右border */
    }
    html{-webkit-text-size-adjust:100%}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{touch-action:manipulation}

    header{display:flex;align-items:center;gap:10px;padding:10px;background:#f0f0f0;border-bottom:1px solid #ddd}
    header .spacer{flex:1}
    .ver{font-size:12px;color:#333;background:#eee;border-radius:999px;padding:3px 10px}

    main{max-width:980px;margin:18px auto 60px;padding:0 12px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-size:16px;color:#fff;background:var(--primary);cursor:pointer}
    .btn.sub{background:#888}
    .btn.compact{padding:8px 10px;font-size:14px}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    label{font-size:14px}
    input[type="text"],select,textarea{font-size:16px} /* iOSズーム対策 */
    input[type="text"]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;width:120px}

    .msg{margin-top:12px;padding:10px 12px;border-radius:8px;font-size:14px;display:none}
    .msg.ok   {display:block;background:#e7f6ec;color:#0f5132;border:1px solid #badbcc}
    .msg.error{display:block;background:#fdecea;color:#842029;border:1px solid #f5c2c0}
    .muted{color:var(--muted)}
    .spinner{width:14px;height:14px;border-radius:50%;border:3px solid #eaeaea;border-top:3px solid var(--primary);animation:spin 1s linear infinite;display:inline-block;vertical-align:-2px;margin-right:6px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ======= 編集表：横・縦スクロール対応 + ヘッダ/先頭列固定 ======= */
    .tableWrap{
      overflow:auto;                         /* 縦横スクロール */
      -webkit-overflow-scrolling:touch;
      border:1px solid #eee;border-radius:10px;background:#fff;
    }
    .tableWrap>table{
      border-collapse:separate;border-spacing:0;table-layout:fixed;
      width:max-content;                     /* 列幅合計を保持 → 横スクロール */
      min-width:100%;                        /* 画面幅以下に縮ませない */
    }
    @supports not (width:max-content){ .tableWrap>table{width:auto} }

    th,td{
      border:1px solid var(--tbl);padding:6px var(--px);text-align:left;background:#fff;
      white-space:normal;overflow-wrap:anywhere;word-break:break-word;box-sizing:border-box;
    }
    thead th{ position:sticky; top:0; z-index:2; background:var(--thead); }
    th:first-child,td:first-child{ position:sticky; left:0; z-index:1; background:#fff; box-shadow:2px 0 0 rgba(0,0,0,.02) }
    thead th:first-child{ z-index:3; background:var(--thead) }
    td[contenteditable="true"]{background:#fffef8;outline:none}

    /* 列幅：指定文字数きっちり（オーバー分は改行） */
    col.w-member{width:calc( 4em + (2*var(--px)) + (2*var(--bw)))}  /* 全角4 */
    col.w-time  {width:calc( 5ch + (2*var(--px)) + (2*var(--bw)))}  /* 半角5 */
    col.w-mod   {width:calc( 5em + (2*var(--px)) + (2*var(--bw)))}  /* 全角5 */
    col.w-course{width:calc( 3em + (2*var(--px)) + (2*var(--bw)))}  /* 全角3 */
    col.w-note  {width:calc( 5em + (2*var(--px)) + (2*var(--bw)))}  /* 全角5 */
    col.w-extra {width:calc(10em + (2*var(--px)) + (2*var(--bw)))}  /* 全角10 */

    .note{font-size:12px;color:#555;margin-top:8px}
    textarea.plain{width:100%;height:480px;border:1px solid #e5e5e5;border-radius:10px;padding:10px;box-sizing:border-box;font-family:ui-monospace,SFMono-Regular,Consolas,Monaco,monospace;font-size:14px;white-space:pre}
    .right{margin-left:auto}
  </style>
</head>
<body>
<header>
  <button class="btn sub" onclick="location.href='top_menu.html'">トップに戻る</button>
  <div class="spacer"></div><span id="version" class="ver">Ver.20250905h</span>
</header>

<main>
  <div class="card">
    <div class="row">
      <label for="dateInput"><strong>日付</strong></label>
      <input id="dateInput" type="text" inputmode="numeric" pattern="\d{8}" placeholder="yyyymmdd" />
      <button id="editBtn"   class="btn">業務連絡編集</button>
      <button id="saveBtn"   class="btn" disabled>内容保存</button>
      <button id="memberBtn" class="btn compact" disabled>メンバ順</button>
      <button id="courseBtn" class="btn compact" disabled>コース順</button>
      <button id="backToTableBtn" class="btn sub right" style="display:none">表に戻す</button>
    </div>
    <div id="msg" class="msg"></div>
    <div id="status" class="note muted">準備完了</div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div id="editorBox">
      <div class="tableWrap" id="tableWrap">
        <table id="editTable" aria-label="業務連絡編集表">
          <colgroup>
            <col class="w-member"/><col class="w-time"/><col class="w-mod"/>
            <col class="w-course"/><col class="w-note"/><col class="w-extra"/>
          </colgroup>
          <thead><tr>
            <th>メンバ</th><th>時刻</th><th>修飾</th><th>コース</th><th>備考</th><th>補足</th>
          </tr></thead>
          <tbody id="editTbody"></tbody>
        </table>
      </div>
      <textarea id="plainText" class="plain" style="display:none"></textarea>
    </div>
    <div class="note">＊「業務連絡編集」で表を生成後に「内容保存」「メンバ順」「コース順」が有効になります。</div>
  </div>
</main>

<script>
/* ===== 設定 ===== */
const GAS_URL="https://script.google.com/macros/s/AKfycbxrnvzng88PDqgnubPyHC1n82EXZn8_zHU9EoAL922BcKwDc4QamCtQlpiaSwdWwS3mNg/exec";
const JOB_FOLDER="job_information", SHIFT_FOLDER="shift_management";

/* コース順（完全一致のみ優先） */
const UNSET='（コース未設定）';
const COURSE_ORDER=['仙石','湖畔','大箱根','川国','東名','磯子','湯本','厚国','三甲','朝霧','若洲','清川','相模'];
const COURSE_ORDER_MAP=(()=>{const m=new Map();COURSE_ORDER.forEach((n,i)=>m.set(n,i));return m})();

/* ===== 要素 ===== */
const $=id=>document.getElementById(id);
const $date=$('dateInput'),$edit=$('editBtn'),$save=$('saveBtn'),$member=$('memberBtn'),$course=$('courseBtn'),$back=$('backToTableBtn');
const $msg=$('msg'),$stat=$('status'),$tbody=$('editTbody'),$table=$('editTable'),$plain=$('plainText'),$wrap=$('tableWrap');

let currentMode='table', tableReady=false;
const headerRow=["メンバ","時刻","修飾","コース","備考","補足"];

/* ===== 共通ユーティリティ ===== */
const setBusy=(on,txt)=>{$stat.innerHTML=on?'<span class="spinner"></span>'+(txt||'処理中…'):(txt||'準備完了');$edit.disabled=on;$save.disabled=on||!tableReady||currentMode!=='table';$member.disabled=on||!tableReady||currentMode!=='table';$course.disabled=on||!tableReady||currentMode!=='table';$back.disabled=on||currentMode!=='text'};
const info=t=>{$msg.className='msg ok';$msg.textContent=t;$msg.style.display='block'};
const err =t=>{$msg.className='msg error';$msg.textContent=t;$msg.style.display='block'};
const clearMsg=()=>{$msg.style.display='none';$msg.textContent=''};
const norm=s=>String(s||'').replace(/\uFEFF/g,'').normalize('NFKC').trim();
const toYmd=d=>`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
const parts=s=>({y:s.slice(0,4),m:s.slice(4,6),d:s.slice(6,8)});
const weekJP=ymd=>['日','月','火','水','木','金','土'][new Date(+parts(ymd).y,+parts(ymd).m-1,+parts(ymd).d).getDay()];

/* ===== CSV ===== */
function parseCSV(t){const s=String(t).replace(/^\uFEFF/,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');const rows=[];let i=0,f='',row=[],q=false;while(i<s.length){const c=s[i];if(q){if(c=='"'){if(s[i+1]=='"'){f+='"';i+=2;continue}q=false;i++;continue}f+=c;i++;continue}else{if(c=='"'){q=true;i++;continue}if(c==','){row.push(f);f='';i++;continue}if(c=='\n'){row.push(f);rows.push(row);f='';row=[];i++;continue}f+=c;i++}}row.push(f);rows.push(row);return rows}
const toCSV=rows=>rows.map(r=>r.map(v=>{const s=String(v??'');return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s}).join(',')).join('\r\n');

/* ===== GAS I/O ===== */
async function gasList(folder,prefix=''){const url=`${GAS_URL}?action=list&folder=${encodeURIComponent(folder)}&prefix=${encodeURIComponent(prefix)}`;const res=await fetch(url,{cache:'no-store'});const raw=await res.text();let data;try{data=JSON.parse(raw)}catch{throw new Error('list 応答がJSONではありません: '+raw.slice(0,120)+'…')}if(data.result!=='success')throw new Error('list 失敗'+(data.message?`（GAS: ${data.message}）`:''));if(!Array.isArray(data.files))throw new Error('list 形式エラー');return data.files}
async function gasRead(folder,file){const url=`${GAS_URL}?action=read&folder=${encodeURIComponent(folder)}&file=${encodeURIComponent(file)}`;const res=await fetch(url,{cache:'no-store'});if(!res.ok)throw new Error(`read 失敗: ${file} / HTTP ${res.status}`);return await res.text()}
async function gasOverwrite(folder,filename,text){const url=`${GAS_URL}?action=overwrite&folder=${encodeURIComponent(folder)}&filename=${encodeURIComponent(filename)}`;const res=await fetch(url,{method:'POST',body:'\uFEFF'+text,cache:'no-store',redirect:'follow',mode:'cors'});if(!res.ok)throw new Error(`overwrite HTTP ${res.status}`);const raw=await res.text();let data;try{data=JSON.parse(raw)}catch{throw new Error('overwrite 応答がJSONではありません: '+raw.slice(0,120)+'…')}if(data.result!=='success')throw new Error('overwrite 失敗'+(data.message?`（GAS: ${data.message}）`:''));return true}

/* ===== シフトCSV → 6列配列 ===== */
const eq=(a,b)=>norm(a)===norm(b);
function findHolidayRowIndex(rows){const t='祝日フラグ';for(let i=0;i<rows.length;i++){if(eq(rows[i]?.[1],t))return i}for(let i=0;i<rows.length;i++){const r=rows[i]||[];for(let j=0;j<r.length;j++){if(eq(r[j],t))return i}}return -1}
function findDateColumn(rows,idx,dd){const row=rows[idx-1]||[];const start=3;const cand=[String(Number(dd,10)),dd.replace(/^0/,'')||dd,dd];for(let c=start;c<row.length;c++){const v=String(row[c]||'').trim();if(cand.includes(v))return c}return -1}
function buildJobArrayFromShift(rows,ymd){
  const i=findHolidayRowIndex(rows); if(i<=0) throw new Error('祝日フラグ行が見つかりません。');
  const {d}=parts(ymd); const col=findDateColumn(rows,i,d); if(col<0) throw new Error(`日付列（${d}日）が見つかりません。`);
  const out=[]; const start=i+2;
  for(let k=0;k<50;k++){
    const r=start+k*3, rN=rows[r]||[], rW=rows[r]||[], rR=rows[r+1]||[];
    if(!rN.length) break;
    const name=(rN[1]||'').toString().trim(); if(/^\d{4}年/.test(name)) break;
    const course=(rW[col]||'').toString().trim();
    const note  =(rR[col]||'').toString().trim();

    // 初期値：修飾/補足
    let mod=''; if(course){ mod = (course==='三甲') ? 'スタート' : '出勤'; }
    let extraInit=''; if(course==='湖畔'||course==='大箱根'){ extraInit='駐車場：'; }

    out.push([name||'', '', mod, course||'', note||'', extraInit]);
  }
  while(out.length<50) out.push(['','','','','','']);
  return out.slice(0,50);
}

/* ===== 描画/収集 ===== */
function renderTableBody(rows){
  $tbody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    for(let c=0;c<headerRow.length;c++){
      const td=document.createElement('td');
      td.contentEditable="true";
      td.textContent=r[c]??'';
      if(c===0) td.style.fontWeight='600';
      tr.appendChild(td);
    }
    $tbody.appendChild(tr);
  });
}
function collectTableBody(){
  const rows=[];
  [...$tbody.querySelectorAll('tr')].forEach(tr=>{
    const cols=[...tr.querySelectorAll('td')].map(td=>td.textContent.trim());
    rows.push([cols[0]||'',cols[1]||'',cols[2]||'',cols[3]||'',cols[4]||'',cols[5]||'']);
  });
  return rows;
}

/* ===== 旧CSV互換（4/5→6列補完） ===== */
function coerceTo6Cols(rs){
  return rs.map(r=>{
    const n=r.length;
    if(n>=6) return [r[0]||'',r[1]||'',r[2]||'',r[3]||'',r[4]||'',r[5]||''];
    if(n===5){ const course=r[2]||''; const mod=course?(course==='三甲'?'スタート':'出勤'):''; return [r[0]||'',r[1]||'',mod,course,r[3]||'',r[4]||'']; }
    if(n===4){ const course=r[1]||''; const mod=course?(course==='三甲'?'スタート':'出勤'):''; return [r[0]||'','',mod,course,r[2]||'',r[3]||'']; }
    return ['','','','','',''];
  });
}

/* ===== 時刻処理 ===== */
const z2h=s=>String(s||'').replace(/[０-９]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFF10+48)).replace(/：/g,':').trim();
function parseMin(s){const x=z2h(s);if(!x)return NaN;const m=x.match(/^(\d{1,2})(?::?(\d{1,2}))?$/);if(!m)return NaN;const h=+m[1],mi=(m[2]!==undefined)?+m[2]:0;return(h>=0&&h<=23&&mi>=0&&mi<=59)?h*60+mi:NaN}
const hm=m=>`${Math.floor(m/60)}:${String(m%60).padStart(2,'0')}`;

/* ===== メンバ順生成 ===== */
function genPlainText(ymd,rows){
  const title=`${+ymd.slice(4,6)}月${+ymd.slice(6,8)}日(${weekJP(ymd)})の業務連絡`;
  const header="メンバ/時刻/コース/備考/補足";
  const lines=[];
  for(const r of rows){
    const member=(r?.[0]??'').trim(), time=(r?.[1]??'').trim(), mod=(r?.[2]??'').trim();
    const course=(r?.[3]??'').trim(), note=(r?.[4]??'').trim(), extra=(r?.[5]??'').trim();
    if(time===''&&course===''&&note===''&&extra==='') continue; // メンバ以外が全空は非表示
    lines.push([member,(time||'')+(mod||''),course||'─',note||'─',extra||'─'].join(' '));
  }
  return lines.length?`${title}\n${header}\n${lines.join('\n')}`:`${title}\n${header}\n(該当なし)`;
}

/* ===== コース順生成 ===== */
function genCourseText(ymd,rows){
  const title=`${+ymd.slice(4,6)}月${+ymd.slice(6,8)}日(${weekJP(ymd)})の業務連絡`;
  const items=[];
  for(const r of rows){
    const member=(r?.[0]??'').trim(), timeRaw=(r?.[1]??'').trim(), mod=(r?.[2]??'').trim();
    const courseRaw=(r?.[3]??'').trim(), note=(r?.[4]??'').trim(), extra=(r?.[5]??'').trim();
    if(timeRaw===''&&courseRaw===''&&note===''&&extra==='') continue;
    const mins=parseMin(timeRaw), label=(Number.isNaN(mins)?(timeRaw||'─'):hm(mins))+(mod||'');
    const courseDisp = courseRaw || UNSET;  // 表記ゆれ吸収なし
    items.push({courseKey:courseDisp,courseDisp,mins,label,mod,member,note:note||'─',extra:extra||'─',ord:items.length});
  }
  if(!items.length) return `${title}\n(該当なし)`;

  const by=new Map();
  for(const it of items){ if(!by.has(it.courseKey)) by.set(it.courseKey,{label:it.courseDisp,rows:[]}); by.get(it.courseKey).rows.push(it); }

  const keys=[...by.keys()],unset=UNSET;
  keys.sort((a,b)=>{
    const aU=a===unset,bU=b===unset; if(aU&&!bU) return 1; if(!aU&&bU) return -1;
    const ai=COURSE_ORDER_MAP.has(a)?COURSE_ORDER_MAP.get(a):Infinity;
    const bi=COURSE_ORDER_MAP.has(b)?COURSE_ORDER_MAP.get(b):Infinity;
    if(ai!==bi) return ai-bi;
    return by.get(a).label.localeCompare(by.get(b).label,'ja');
  });

  const out=[title];
  for(const k of keys){
    const g=by.get(k); out.push(g.label);
    const groups=new Map(); // key = `${mins}|${mod}`
    for(const it of g.rows){
      const key=(Number.isNaN(it.mins)?'NaN':String(it.mins))+'|'+(it.mod||'');
      if(!groups.has(key)) groups.set(key,{mins:it.mins,label:it.label,rows:[]});
      groups.get(key).rows.push(it);
    }
    const ks=[...groups.keys()].sort((a,b)=>{
      const A=groups.get(a),B=groups.get(b),an=Number.isNaN(A.mins),bn=Number.isNaN(B.mins);
      if(an&&!bn) return 1; if(!an&&bn) return -1;
      if(A.mins!==B.mins) return A.mins-B.mins;
      return A.label.localeCompare(B.label,'ja');
    });
    for(const kk of ks){
      const t=groups.get(kk); out.push(` ${t.label}`);
      t.rows.sort((x,y)=>x.ord-y.ord);
      for(const r of t.rows){ out.push(`  ${r.member} ${r.note} ${r.extra}`); }
    }
  }
  return out.join('\n');
}

/* ===== 既存CSV確認/ロード ===== */
async function tryLoadExisting(ymd){
  const files=await gasList(JOB_FOLDER), csv=`${ymd}_業務連絡.csv`;
  if(files.includes(csv)){
    if(!confirm('該当ファイルがあるので編集しますか。')) return null;
    const text=await gasRead(JOB_FOLDER,csv),rows=parseCSV(text);
    return coerceTo6Cols(rows.slice(1)).slice(0,50);
  }else{
    if(!confirm('該当ファイルが無いので新規作成しますか。')) return null;
    return undefined;
  }
}

/* ===== 新規作成：シフトCSV選定・読込 ===== */
async function buildFromShiftEntry(ymd){
  const files=await gasList(SHIFT_FOLDER), {y,m}=parts(ymd);
  const pref=`${Number(y)}年${String(Number(m)).padStart(2,'0')}月 GOLKANOシフト情報`;
  const cand=files.filter(n=>n.startsWith(pref)&&/\.csv$/i.test(n));
  let target;
  if(cand.length){ target=cand.sort((a,b)=>b.localeCompare(a,'ja'))[0]; }
  else{
    const all=files.filter(n=>/GOLKANOシフト情報/.test(n)&&/\.csv$/i.test(n));
    if(!all.length) throw new Error('シフトCSVが見つかりませんでした。');
    target=all.sort((a,b)=>b.localeCompare(a,'ja'))[0];
    info('当月ファイルが見つからないため、最新のシフトCSVから作成します。');
  }
  const text=await gasRead(SHIFT_FOLDER,target),rows=parseCSV(text);
  return buildJobArrayFromShift(rows,ymd);
}

/* ===== 表示領域：縦スクロール高さの自動調整 ===== */
function fitTableViewport(){
  const wrap=$wrap; if(!wrap) return;
  const rect=wrap.getBoundingClientRect();
  const bottomGap=16; // 下余白
  const maxH=Math.max(240, Math.floor(window.innerHeight - rect.top - bottomGap));
  wrap.style.maxHeight = maxH + 'px';   // 縦スクロール領域を確保（ヘッダは sticky で常に上）
}

/* ===== 初期化・ハンドラ ===== */
(function init(){
  const t=new Date(); t.setDate(t.getDate()+1); $date.value=toYmd(t);

  $edit.addEventListener('click',async()=>{
    clearMsg(); setBusy(true,'編集中データの準備…');
    try{
      const ymd=($date.value||'').trim();
      if(!/^\d{8}$/.test(ymd)) throw new Error('日付は yyyymmdd の8桁で入力してください。');
      const exist=await tryLoadExisting(ymd);
      if(exist===null){ setBusy(false,'待機中'); return; }
      const arr=Array.isArray(exist)?exist:await buildFromShiftEntry(ymd);
      renderTableBody(arr);
      fitTableViewport();                 // 縦スクロール高さ調整
      tableReady=true;
      setBusy(false,'編集表を表示中'); info('編集表を用意しました。セルは直接編集できます。');
      $save.disabled=false; $member.disabled=false; $course.disabled=false;
    }catch(e){ console.error(e); err(e.message||'編集準備に失敗しました。'); setBusy(false,'待機中'); }
  });

  $save.addEventListener('click',async()=>{
    if(!$save.disabled && currentMode!=='table'){ err('テキスト表示中は保存できません。表に戻してください。'); return; }
    if(!tableReady) return;
    clearMsg(); setBusy(true,'CSV保存中…');
    try{
      const ymd=($date.value||'').trim();
      if(!/^\d{8}$/.test(ymd)) throw new Error('日付が不正です。');
      const body=collectTableBody(), rows=[headerRow,...body], csv=toCSV(rows), file=`${ymd}_業務連絡.csv`;
      await gasOverwrite(JOB_FOLDER,file,csv); // 確認なし上書き（BOM付UTF-8）
      setBusy(false,'保存完了'); info(`「${file}」として保存しました。`);
    }catch(e){ console.error(e); err(e.message||'保存に失敗しました。'); setBusy(false,'待機中'); }
  });

  $member.addEventListener('click',()=>{
    if(!tableReady) return; clearMsg();
    const h=$('editorBox').offsetHeight;
    $table.style.display='none'; $plain.style.display='block'; $plain.style.height=(h-20)+'px';
    const ymd=($date.value||'').trim(); $plain.value=genPlainText(ymd,collectTableBody());
    currentMode='text'; $back.style.display='inline-block'; setBusy(false,'テキスト表示中');
  });

  $course.addEventListener('click',()=>{
    if(!tableReady) return; clearMsg();
    const h=$('editorBox').offsetHeight;
    $table.style.display='none'; $plain.style.display='block'; $plain.style.height=(h-20)+'px';
    const ymd=($date.value||'').trim(); $plain.value=genCourseText(ymd,collectTableBody());
    currentMode='text'; $back.style.display='inline-block'; setBusy(false,'テキスト表示中');
  });

  $back.addEventListener('click',()=>{
    $plain.style.display='none'; $table.style.display='';
    fitTableViewport();                  // 表へ戻ったら再計算
    currentMode='table'; $back.style.display='none';
    setBusy(false,'編集表を表示中');
  });

  // 画面回転・リサイズで縦スクロール高さを追従
  let _fitTimer=null;
  ['resize','orientationchange'].forEach(ev=>{
    window.addEventListener(ev,()=>{ clearTimeout(_fitTimer); _fitTimer=setTimeout(fitTableViewport,100); });
  });

  // 初期1回（空でも一応高さセット）
  fitTableViewport();
})();
</script>
</body>
</html>
