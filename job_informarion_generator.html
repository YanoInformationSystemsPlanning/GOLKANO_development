<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>業務連絡生成</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root { --fg:#222; --muted:#666; --ok:#28a745; --error:#d9534f; --primary:#2b7cff; --card:#fff; --bg:#f7f7f7; }
    html,body{margin:0;padding:0;background:var(--bg);color:#222;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    header{display:flex;align-items:center;gap:10px;padding:10px;background:#f0f0f0;border-bottom:1px solid #ddd;}
    header .spacer{flex:1;}
    .ver{font-size:12px;color:#333;background:#eee;border-radius:999px;padding:3px 10px;}
    main{max-width:980px;margin:18px auto 60px;padding:0 12px;}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px;}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-size:15px;color:#fff;background:var(--primary);cursor:pointer}
    .btn.sub{background:#888}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    label{font-size:14px}
    input[type="text"]{font-size:15px;padding:8px 10px;border:1px solid #ddd;border-radius:8px;width:120px}
    .msg{margin-top:12px;padding:10px 12px;border-radius:8px;font-size:14px;display:none}
    .msg.ok{display:block;background:#e7f6ec;color:#0f5132;border:1px solid #badbcc}
    .msg.error{display:block;background:#fdecea;color:#842029;border:1px solid #f5c2c0}
    .muted{color:var(--muted)}
    .spinner{width:14px;height:14px;border-radius:50%;border:3px solid #eaeaea;border-top:3px solid var(--primary);animation:spin 1s linear infinite;display:inline-block;vertical-align:-2px;margin-right:6px}
    @keyframes spin{to{transform:rotate(360deg)}}
    table{border-collapse:separate;border-spacing:0;width:100%;font-size:14px}
    th,td{border:1px solid #e5e5e5;padding:6px 8px;text-align:left}
    thead th{position:sticky;top:0;background:#f8fbff}
    td[contenteditable="true"]{background:#fffef8;outline:none}
    .note{font-size:12px;color:#555;margin-top:8px}
    textarea.plain{width:100%;height:480px;border:1px solid #e5e5e5;border-radius:10px;padding:10px;box-sizing:border-box;font-family:ui-monospace,SFMono-Regular,Consolas,Monaco,monospace;font-size:14px;white-space:pre}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <header>
    <button class="btn sub" onclick="location.href='top_menu.html'">トップに戻る</button>
    <div class="spacer"></div>
    <span id="version" class="ver">Ver.20250904k</span>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <label for="dateInput"><strong>日付</strong></label>
        <input id="dateInput" type="text" inputmode="numeric" pattern="\d{8}" placeholder="yyyymmdd" />
        <button id="editBtn" class="btn">業務連絡編集</button>
        <button id="saveBtn" class="btn" disabled>内容保存</button>
        <button id="memberBtn" class="btn" disabled>メンバ順生成</button>
        <button id="courseBtn" class="btn" disabled>コース順生成</button>
        <button id="backToTableBtn" class="btn sub right" style="display:none">表に戻す</button>
      </div>
      <div id="msg" class="msg"></div>
      <div id="status" class="note muted">準備完了</div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div id="editorBox">
        <table id="editTable" aria-label="業務連絡編集表">
          <thead>
            <tr>
              <th style="width:200px">メンバ</th>
              <th style="width:120px">出勤時刻</th>
              <th style="width:220px">コース</th>
              <th style="width:220px">備考</th>
              <th style="width:160px">補足</th>
            </tr>
          </thead>
          <tbody id="editTbody"></tbody>
        </table>
        <textarea id="plainText" class="plain" style="display:none"></textarea>
      </div>
      <div class="note" id="footNote">＊「業務連絡編集」で表を生成後に「内容保存」「メンバ順生成」「コース順生成」が有効になります。</div>
    </div>
  </main>

  <script>
    // ====== 設定 ======
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxrnvzng88PDqgnubPyHC1n82EXZn8_zHU9EoAL922BcKwDc4QamCtQlpiaSwdWwS3mNg/exec";
    const JOB_FOLDER   = "job_information";
    const SHIFT_FOLDER = "shift_management";
    const VERSION = "20250904k";

    // === 変更点: コース表示順の固定定義＋正規化/別名対応 ===
    const UNSET_LABEL = '（コース未設定）';
    const COURSE_ORDER = [
      '仙石','湖畔','大箱根','川国','東名','磯子','湯本','厚国','三甲','朝霧','若洲','清川','相模'
    ];
    function courseNorm(s){ return String(s||'').normalize('NFKC').trim(); }
    function courseCanon(s){
      const n = courseNorm(s);
      const alias = new Map([
        ['川国の','川国'],        // 表記ゆれ吸収（必要に応じて増やせます）
        ['厚木国際','厚国'],
        ['厚木国際ＣＣ','厚国'],
        ['厚木国際CC','厚国']
      ]);
      const v = alias.get(n) || n;
      return v || UNSET_LABEL;
    }
    const COURSE_ORDER_MAP = (()=>{ const m=new Map(); COURSE_ORDER.forEach((nm,i)=>m.set(courseCanon(nm), i)); return m; })();

    // ====== 要素 ======
    const $date = document.getElementById('dateInput');
    const $edit = document.getElementById('editBtn');
    const $save = document.getElementById('saveBtn');
    const $member = document.getElementById('memberBtn');
    const $course = document.getElementById('courseBtn');
    const $back = document.getElementById('backToTableBtn');
    const $msg  = document.getElementById('msg');
    const $stat = document.getElementById('status');
    const $tbody= document.getElementById('editTbody');
    const $table= document.getElementById('editTable');
    const $plain= document.getElementById('plainText');
    const $ver  = document.getElementById('version');

    let currentMode = 'table';
    let tableReady = false;

    // 5列ヘッダ
    const headerRow = ["メンバ","出勤時刻","コース","備考","補足"];

    // ====== ユーティリティ ======
    function setBusy(on, text){
      $stat.innerHTML = on ? '<span class="spinner"></span>'+(text||'処理中…') : (text || '準備完了');
      $edit.disabled = on;
      $save.disabled = on || !tableReady || currentMode!=='table';
      $member.disabled = on || !tableReady || currentMode!=='table';
      $course.disabled = on || !tableReady || currentMode!=='table';
      $back.disabled = on || currentMode!=='text';
    }
    function info(t){ $msg.className='msg ok'; $msg.textContent=t; $msg.style.display='block'; }
    function err(t){ $msg.className='msg error'; $msg.textContent=t; $msg.style.display='block'; }
    function clearMsg(){ $msg.style.display='none'; $msg.textContent=''; }
    const norm = (s)=> String(s||'').replace(/\uFEFF/g,'').normalize('NFKC').trim();
    const toYmd = (d)=> `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
    function ymdParts(yyyymmdd){ return { y:yyyymmdd.slice(0,4), m:yyyymmdd.slice(4,6), d:yyyymmdd.slice(6,8) }; }
    function weekJP(yyyymmdd){
      const {y,m,d}=ymdParts(yyyymmdd);
      const dt=new Date(Number(y), Number(m)-1, Number(d));
      return ['日','月','火','水','木','金','土'][dt.getDay()];
    }

    function parseCSV(text){
      const s = String(text).replace(/^\uFEFF/,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');
      const rows=[];let i=0,f='',row=[],q=false;
      while(i<s.length){
        const c=s[i];
        if(q){ if(c=='"'){ if(s[i+1]=='"'){f+='"';i+=2;continue;} q=false;i++;continue;} f+=c;i++;continue; }
        else { if(c=='"'){q=true;i++;continue;} if(c==','){row.push(f);f='';i++;continue;} if(c=='\n'){row.push(f);rows.push(row);f='';row=[];i++;continue;} f+=c;i++; }
      }
      row.push(f); rows.push(row); return rows;
    }
    function toCSV(rows){
      return rows.map(r=>r.map(v=>{
        const s=String(v??''); return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
      }).join(',')).join('\r\n');
    }

    // ====== GAS I/O ======
    async function gasList(folder, prefix=''){
      const url = `${GAS_URL}?action=list&folder=${encodeURIComponent(folder)}&prefix=${encodeURIComponent(prefix)}`;
      const res = await fetch(url,{cache:'no-store'});
      const raw = await res.text();
      let data; try{ data=JSON.parse(raw); }catch(e){ throw new Error('list 応答がJSONではありません: '+raw.slice(0,120)+'…'); }
      if(data.result!=='success') throw new Error('list 失敗'+(data.message?`（GAS: ${data.message}）`:''));
      if(!Array.isArray(data.files)) throw new Error('list 形式エラー（files が配列ではありません）');
      return data.files;
    }
    async function gasRead(folder, file){
      const url = `${GAS_URL}?action=read&folder=${encodeURIComponent(folder)}&file=${encodeURIComponent(file)}`;
      const res = await fetch(url,{cache:'no-store'});
      if(!res.ok) throw new Error(`read 失敗: ${file} / HTTP ${res.status}`);
      return await res.text();
    }
    async function gasOverwrite(folder, filename, text){
      const url = `${GAS_URL}?action=overwrite&folder=${encodeURIComponent(folder)}&filename=${encodeURIComponent(filename)}`;
      const res = await fetch(url,{
        method:'POST',
        body: '\uFEFF' + text, // BOM付きUTF-8（Excel文字化け対策）
        cache: 'no-store',
        redirect: 'follow',
        mode: 'cors'
      });
      if(!res.ok) throw new Error(`overwrite HTTP ${res.status}`);
      const raw = await res.text();
      let data; try{ data=JSON.parse(raw);}catch(e){ throw new Error('overwrite 応答がJSONではありません: '+raw.slice(0,120)+'…'); }
      if(data.result!=='success') throw new Error('overwrite 失敗'+(data.message?`（GAS: ${data.message}）`:''));
      return true;
    }

    // ====== シフトCSV → 配列（5列：メンバ,出勤時刻,コース,備考,補足） ======
    function equals(a,b){ return norm(a)===norm(b); }
    function findHolidayRowIndex(rows){
      const target='祝日フラグ';
      for(let i=0;i<rows.length;i++){ if(equals(rows[i]?.[1],target)) return i; }
      for(let i=0;i<rows.length;i++){ const r=rows[i]||[]; for(let j=0;j<r.length;j++){ if(equals(r[j],target)) return i; } }
      return -1;
    }
    function findDateColumn(rows, idxHoliday, dd){
      const rowDate = rows[idxHoliday-1] || [];
      const startCol = 3; // dd+3 列起点
      const candidates = [String(Number(dd,10)), dd.replace(/^0/,'') || dd, dd];
      for(let c=startCol;c<rowDate.length;c++){
        const v = String(rowDate[c]||'').trim();
        if(candidates.includes(v)) return c;
      }
      return -1;
    }
    function ymdParts(yyyymmdd){ return { y:yyyymmdd.slice(0,4), m:yyyymmdd.slice(4,6), d:yyyymmdd.slice(6,8) }; }
    function buildJobArrayFromShift(rows, yyyymmdd){
      const idxHoliday = findHolidayRowIndex(rows);
      if(idxHoliday<=0) throw new Error('祝日フラグ行が見つかりません。');
      const {d} = ymdParts(yyyymmdd);
      const col = findDateColumn(rows, idxHoliday, d);
      if(col<0) throw new Error(`日付列（${d}日）が見つかりません。`);

      const out = [];
      const startRow = idxHoliday + 2; // 2行下から
      for(let i=0;i<50;i++){
        const r = startRow + i*3;
        const rName = rows[r] || [];
        const rWork = rows[r] || [];
        const rRmks = rows[r+1] || [];
        if(!rName.length) break;

        const name = (rName[1]||'').toString().trim();
        if(/^\d{4}年/.test(name)) break; // 年見出しで打切り

        if(!name){ out.push(['','','','','']); continue; }
        const course = (rWork[col]||'').toString().trim();
        const note   = (rRmks[col]||'').toString().trim();
        out.push([name, '', course, note, '']); // 出勤時刻 初期空
      }
      while(out.length<50) out.push(['','','','','']);
      return out.slice(0,50);
    }

    // ====== 描画/収集 ======
    function renderTableBody(rows){
      const $tb=$tbody; $tb.innerHTML='';
      rows.forEach((r)=>{
        const tr=document.createElement('tr');
        for(let c=0;c<headerRow.length;c++){
          const td=document.createElement('td');
          td.contentEditable = "true";
          td.textContent = r[c] ?? '';
          if(c===0) td.style.fontWeight='600';
          tr.appendChild(td);
        }
        $tb.appendChild(tr);
      });
    }
    function collectTableBody(){
      const rows=[];
      [...$tbody.querySelectorAll('tr')].forEach(tr=>{
        const cols=[...tr.querySelectorAll('td')].map(td=>td.textContent.trim());
        const fixed = [cols[0]||'', cols[1]||'', cols[2]||'', cols[3]||'', cols[4]||''];
        rows.push(fixed);
      });
      return rows;
    }

    // ====== 旧4列→5列補正 ======
    function coerceTo5Cols(rows){
      return rows.map(r=>{
        if(r.length>=5) return [r[0]||'', r[1]||'', r[2]||'', r[3]||'', r[4]||''];
        return [r[0]||'', '', r[1]||'', r[2]||'', r[3]||'']; // 出勤時刻は空
      });
    }

    // ====== 文字種正規化（時刻用） ======
    function z2hDigitsAndColon(s){
      return String(s||'').replace(/[０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFF10+48))
                          .replace(/：/g, ':')
                          .trim();
    }
    function parseTimeToMinutes(s){
      const x = z2hDigitsAndColon(s);
      if (!x) return NaN;
      const m = x.match(/^(\d{1,2})(?::?(\d{1,2}))?$/);
      if(!m) return NaN;
      let h = parseInt(m[1],10);
      let min = m[2]!==undefined ? parseInt(m[2],10) : 0;
      if(!(h>=0 && h<=23 && min>=0 && min<=59)) return NaN;
      return h*60+min;
    }
    function formatMinutesToHM(mins){
      const h = Math.floor(mins/60);
      const m = mins%60;
      return `${h}:${String(m).padStart(2,'0')}`; // 時は先頭ゼロなし
    }

    // ====== メンバ順：ヘッダ固定／空欄置換ルール ======
    function genPlainText(yyyymmdd, bodyRows){
      const title = `【${Number(yyyymmdd.slice(4,6))}月${Number(yyyymmdd.slice(6,8))}日(${weekJP(yyyymmdd)})の業務連絡】`;
      const headerLine = "メンバ/出勤時刻/コース/備考/補足";
      const lines = [];
      for (const r of bodyRows) {
        const member = String(r?.[0] ?? '').trim();
        const time   = String(r?.[1] ?? '').trim();
        const course = String(r?.[2] ?? '').trim();
        const note   = String(r?.[3] ?? '').trim();
        const extra  = String(r?.[4] ?? '').trim();

        // メンバ以外が全空ならスキップ
        if (time==='' && course==='' && note==='' && extra==='') continue;

        lines.push([
          member,
          time,
          course || '─',
          note   || '─',
          extra  || '─'
        ].join(' '));
      }
      return lines.length === 0
        ? `${title}\n${headerLine}\n(該当なし)`
        : `${title}\n${headerLine}\n${lines.join('\n')}`;
    }

    // ====== コース順：コース（固定順）→時刻→メンバ ======
    function genCourseText(yyyymmdd, bodyRows){
      const title = `${Number(yyyymmdd.slice(4,6))}月${Number(yyyymmdd.slice(6,8))}日(${weekJP(yyyymmdd)})の業務連絡`;

      // 1) 出力対象抽出（メンバ以外が全空は除外）
      const items = [];
      for (const r of bodyRows) {
        const member = String(r?.[0] ?? '').trim();
        const timeRaw= String(r?.[1] ?? '').trim();
        const courseRaw = String(r?.[2] ?? '').trim();
        const note   = String(r?.[3] ?? '').trim();
        const extra  = String(r?.[4] ?? '').trim();
        if (timeRaw==='' && courseRaw==='' && note==='' && extra==='') continue;

        const mins = parseTimeToMinutes(timeRaw);
        const timeLabel = Number.isNaN(mins) ? (timeRaw || '─') : formatMinutesToHM(mins);

        // === 変更点: コース名の正準化（固定順に沿うため）
        const courseDisp = courseCanon(courseRaw) || UNSET_LABEL; // 表示用
        const courseKey  = courseDisp;                             // キーも正準名

        items.push({
          courseKey, courseDisp,
          mins, timeLabel,
          member,
          noteOut:  note || '─',
          extraOut: extra || '─',
          _order: items.length
        });
      }
      if(items.length===0) return `${title}\n(該当なし)`;

      // 2) コースでグルーピング
      const byCourse = new Map();
      for(const it of items){
        if(!byCourse.has(it.courseKey)) byCourse.set(it.courseKey, { label: it.courseDisp, rows: [] });
        byCourse.get(it.courseKey).rows.push(it);
      }

      // 3) コースキーの並び：定義順 → 未定義（ラベル昇順）→ 未設定は最後
      const courseKeys = Array.from(byCourse.keys());
      const unsetKey = UNSET_LABEL; // 正準名をそのままキーに使用
      courseKeys.sort((ka, kb)=>{
        const aUnset = (ka === unsetKey), bUnset = (kb === unsetKey);
        if(aUnset && !bUnset) return 1;
        if(!aUnset && bUnset) return -1;
        const ai = COURSE_ORDER_MAP.has(ka) ? COURSE_ORDER_MAP.get(ka) : Infinity;
        const bi = COURSE_ORDER_MAP.has(kb) ? COURSE_ORDER_MAP.get(kb) : Infinity;
        if(ai !== bi) return ai - bi;
        const la = byCourse.get(ka).label;
        const lb = byCourse.get(kb).label;
        return la.localeCompare(lb, 'ja');
      });

      // 4) 各コース内：時刻でまとめ、同一時刻は表の出現順
      const out = [title];
      for(const k of courseKeys){
        const grp = byCourse.get(k);
        out.push(grp.label);

        const groups = new Map(); // 分 or 'NaN' → { mins, label, rows }
        for(const it of grp.rows){
          const key = Number.isNaN(it.mins) ? 'NaN' : String(it.mins);
          if(!groups.has(key)) groups.set(key, { mins: it.mins, label: it.timeLabel, rows: [] });
          groups.get(key).rows.push(it);
        }
        const keys = Array.from(groups.keys()).sort((ka,kb)=>{
          const ga=groups.get(ka), gb=groups.get(kb);
          const aNaN = Number.isNaN(ga.mins), bNaN = Number.isNaN(gb.mins);
          if(aNaN && !bNaN) return 1;
          if(!aNaN && bNaN) return -1;
          return (ga.mins - gb.mins);
        });

        for(const kk of keys){
          const g = groups.get(kk);
          out.push(` ${g.label}`); // 1段インデント
          g.rows.sort((x,y)=> x._order - y._order);
          for(const r of g.rows){
            out.push(`  ${r.member} ${r.noteOut} ${r.extraOut}`); // 2段インデント
          }
        }
      }
      return out.join('\n');
    }

    // ====== 既存CSVの確認/ロード ======
    async function tryLoadExisting(yyyymmdd){
      const files = await gasList(JOB_FOLDER);
      const csv = `${yyyymmdd}_業務連絡.csv`;
      const hasCsv = files.includes(csv);
      if(hasCsv){
        if(!confirm('該当ファイルがあるので編集しますか。')) return null;
        const text = await gasRead(JOB_FOLDER, csv);
        const rows = parseCSV(text);
        const body = coerceTo5Cols(rows.slice(1)); // 先頭はヘッダ
        return body.slice(0,50);
      }else{
        if(!confirm('該当ファイルが無いので新規作成しますか。')) return null;
        return undefined;
      }
    }

    // ====== 新規作成：シフトCSVの決定・読込 ======
    function ymdToMonthPrefix(yyyymmdd){
      const {y,m} = ymdParts(yyyymmdd);
      return `${Number(y)}年${String(Number(m)).padStart(2,'0')}月 GOLKANOシフト情報`;
    }
    async function buildFromShift(yyyymmdd){
      const files = await gasList(SHIFT_FOLDER);
      const monthPrefix = ymdToMonthPrefix(yyyymmdd);
      const candidates = files.filter(n => n.startsWith(monthPrefix) && /\.csv$/i.test(n));
      let target;
      if(candidates.length){
        target = candidates.sort((a,b)=> b.localeCompare(a,'ja'))[0];
      }else{
        const all = files.filter(n => /GOLKANOシフト情報/.test(n) && /\.csv$/i.test(n));
        if(!all.length) throw new Error('シフトCSVが見つかりませんでした。');
        target = all.sort((a,b)=> b.localeCompare(a,'ja'))[0];
        info('当月ファイルが見つからないため、最新のシフトCSVから作成します。');
      }
      const text = await gasRead(SHIFT_FOLDER, target);
      const rows = parseCSV(text);
      return buildJobArrayFromShift(rows, yyyymmdd);
    }

    // ====== 初期化 & ハンドラ ======
    (function init(){
      $ver.textContent = `Ver.${VERSION}`;
      const t = new Date(); t.setDate(t.getDate()+1); // 操作日 + 1日
      $date.value = toYmd(t);

      $edit.addEventListener('click', async()=>{
        clearMsg(); setBusy(true,'編集中データの準備…');
        try{
          const ymd = ($date.value||'').trim();
          if(!/^\d{8}$/.test(ymd)) throw new Error('日付は yyyymmdd の8桁で入力してください。');
          const exist = await tryLoadExisting(ymd);
          if(exist===null){ setBusy(false,'待機中'); return; }
          const arr = Array.isArray(exist) ? exist : await buildFromShift(ymd);
          renderTableBody(arr);
          tableReady = true;
          setBusy(false,'編集表を表示中');
          info('編集表を用意しました。セルは直接編集できます。');
          $save.disabled=false; $member.disabled=false; $course.disabled=false;
        }catch(e){
          console.error(e); err(e.message||'編集準備に失敗しました。'); setBusy(false,'待機中');
        }
      });

      $save.addEventListener('click', async()=>{
        if(!$save.disabled && currentMode!=='table'){ err('テキスト表示中は保存できません。表に戻してください。'); return; }
        if(!tableReady) return;
        clearMsg(); setBusy(true,'CSV保存中…');
        try{
          const ymd = ($date.value||'').trim();
          if(!/^\d{8}$/.test(ymd)) throw new Error('日付が不正です。');
          const bodyRows = collectTableBody();
          const rows = [headerRow, ...bodyRows];
          const csv = toCSV(rows);
          const file = `${ymd}_業務連絡.csv`;
          await gasOverwrite(JOB_FOLDER, file, csv); // 確認なしで上書き
          setBusy(false,'保存完了'); info(`「${file}」として保存しました。`);
        }catch(e){
          console.error(e); err(e.message||'保存に失敗しました。'); setBusy(false,'待機中');
        }
      });

      // メンバ順生成
      $member.addEventListener('click', ()=>{
        if(!tableReady) return;
        clearMsg();
        const box = document.getElementById('editorBox');
        const h = box.offsetHeight;
        $table.style.display='none';
        $plain.style.display='block';
        $plain.style.height = (h-20)+'px';
        const ymd = ($date.value||'').trim();
        const bodyRows = collectTableBody();
        $plain.value = genPlainText(ymd, bodyRows);
        currentMode = 'text';
        $back.style.display='inline-block';
        setBusy(false,'テキスト表示中');
      });

      // コース順生成（固定順で出力）
      $course.addEventListener('click', ()=>{
        if(!tableReady) return;
        clearMsg();
        const box = document.getElementById('editorBox');
        const h = box.offsetHeight;
        $table.style.display='none';
        $plain.style.display='block';
        $plain.style.height = (h-20)+'px';
        const ymd = ($date.value||'').trim();
        const bodyRows = collectTableBody();
        $plain.value = genCourseText(ymd, bodyRows);
        currentMode = 'text';
        $back.style.display='inline-block';
        setBusy(false,'テキスト表示中');
      });

      $back.addEventListener('click', ()=>{
        $plain.style.display='none';
        $table.style.display='';
        currentMode='table';
        $back.style.display='none';
        setBusy(false,'編集表を表示中');
      });
    })();
  </script>
</body>
</html>
